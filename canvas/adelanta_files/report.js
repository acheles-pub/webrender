var ReportSettings={applURL:"",apiUrl:"",templates:null,"nkb.file.download.template":"","egrul.list.url":"","report.url.template":"",effects:{duration:100,updateTimeout:200,functionWaitTimeout:500,deferTimeout:50,mousewheelStep:20},paging:{pageSize:5},historySize:10,footerHeight:25,graphObjectSpacing:20,drag:{node:{gridSize:10}},windowBounds:{left:0,top:40,right:1000000,bottom:1000000},areaBounds:{left:20,top:65,right:1000000,bottom:1000000}};function Report(a7){var ah=$(window);var N=$(document);var ae=$("body");var br=null;var K=$(ReportSettings.templates);var bd=$(a7.container);var aj="node-graph-view";var aI="relation-label";var ap={"svg":{"solid":{dashstyle:"none"},"dotted":{dashstyle:"1 3"},"dashed":{dashstyle:"8 3"}},"vml":{"solid":{dashstyle:"none","svg-stroke-dasharray":""},"dotted":{dashstyle:"dot","svg-stroke-dasharray":"2 6"},"dashed":{dashstyle:"longdash","svg-stroke-dasharray":"16 6"}}};function a4(bt){var bu={};if(!bt){return bu}var bv=jsPlumb.getRenderMode();if(bv==jsPlumb.SVG){return ap["svg"][bt]}else{if(bv==jsPlumb.VML){return ap["vml"][bt]}else{return bu}}}var U={detachable:false,cssClass:"relation",anchor:"Continuous",connector:["StateMachine",{margin:1,curviness:10,proximityLimit:20}],paintStyle:{strokeStyle:"#999999",dashstyle:"none",lineWidth:2},endpoints:[["Dot",{radius:4,cssClass:"relation-endpoint"}],["Blank"]],endpointStyle:{fillStyle:"#999999"}};var a0={hoverPaintStyle:{strokeStyle:"#004466",lineWidth:2},selectPaintStyle:{lineWidth:4},endpointHoverStyle:{fillStyle:"#004466"},endpointSelectStyle:{},nodeSelectPaintStyle:{strokeStyle:"#004466"}};var d=[ReportSettings.areaBounds.left,ReportSettings.areaBounds.top,ReportSettings.areaBounds.right,ReportSettings.areaBounds.bottom];var T=new MessageWidget({container:bd,position:"fixed"});var a8={openReport:"openReport",openUrlNodes:"openUrlNodes",objectNote:"objectNote",reportNote:"reportNote",addNode:"addNode",addRelatedNode:"addRelatedNode",deleteNode:"deleteNode",searchRelation:"searchRelation",linkNodes:"linkNodes",deleteLinkNodes:"deleteLinkNodes",objectTheme:"objectTheme",lineStyle:"lineStyle",drag:"drag",doHistory:"doHistory",update:"update"};var aK=[a8.openReport,a8.openUrlNodes,a8.addNode,a8.addRelatedNode,a8.deleteNode,a8.searchRelation,a8.linkNodes,a8.deleteLinkNodes,a8.objectTheme,a8.drag];var ax=[a8.openReport];var w=[a8.openReport,a8.openUrlNodes,a8.addNode,a8.addRelatedNode,a8.deleteNode,a8.searchRelation,a8.doHistory];var aU=[a8.openUrlNodes];var aD={NodeModel:"NodeModel",LinkNodeModel:"LinkNodeModel"};var bq={NodeGraphView:"NodeGraphView",LinkNodeGraphView:"LinkNodeGraphView",RelationLabelView:"RelationLabelView"};var u=Backbone.Model.extend({url:ReportSettings.apiUrl+"/report",fetch:function(bt){bt=bt||{};bt.url=this.url+"/"+this.id;return Backbone.Model.prototype.fetch.call(this,bt)},fetchShared:function(bu,bt){bt=bt||{};bt.url=this.url+"/shared/"+bu;return Backbone.Model.prototype.fetch.call(this,bt)},sync:function(bv,bu,bt){bv=(bv.toLowerCase()==="patch"?"update":bv);return Backbone.Model.prototype.sync.call(this,bv,bu,bt)},partialSave:function(bu,bt){var bv=this;bu=_.extend(bu,{id:bv.id});bt=_.extend(bt,{patch:true});return bv.save(bu,bt)},destroy:function(bt){bt=bt||{};bt.url=this.url+"/"+this.id;return Backbone.Model.prototype.destroy.call(this,bt)}});var au=Backbone.Collection.extend({model:u,url:ReportSettings.apiUrl+"/reports"});var aF=Backbone.Model.extend({});var t=Backbone.Collection.extend({model:aF,url:ReportSettings.apiUrl+"/meta/node/types",getByName:function(bt){return this.find(function(bu){return bu.get("name")==bt})}});var aY=new t();var R=Backbone.Model.extend({});var bf=Backbone.Collection.extend({model:R,url:ReportSettings.apiUrl+"/meta/relation/types",getByName:function(bt){return this.find(function(bu){return bu.get("name")==bt})}});var an=new bf();function e(bu,bt){return"node-"+bt.toLowerCase()+"-"+bu}var aq=Backbone.Model.extend({idAttribute:"_id",className:aD.NodeModel,initialize:function(){this.uid=e(this.id,this.get("_type"));this.viewId="view-"+this.uid},url:function(){return ReportSettings.apiUrl+"/node/"+this.id},displayValue:function(bu,bt,bv){return MetaUtils.nodeDisplayValue(this.attributes,bu,bt,bv)},getLiqStatus:function(){var bu=this;var bv=null;if(bu.get("_type")=="COMPANY"){var bw=bu.get("egrul_state");var bt=5;if(bw&&bw.code!=bt){bv={state:{_actual:bw._actual,_since:bw._since,type:bw.type}}}else{if(bu.get("dead_dt")){bv={state:{_actual:null,_since:bu.get("dead_dt"),type:null}}}}}bu.set("_liqStatus",bv,{silent:true});return bv},getRelationCount:function(bz,bv,bA){var bx=this;var bu=bx.get("_relations");if(!bu){return 0}var bw=0;var bt=[];$.each(bx.get("_relations"),function(bC,bD){if(_.contains(bz,bD._type)&&(bv?bD._dstId==bx.id:bD._srcId==bx.id)){var bB=by(bD);if(!_.contains(bt,bB)){bt.push(bB);bw++;if(bA&&bw>bA){return false}}}});function by(bB){return bB._type+"."+bB._srcId+"."+bB._dstId}return bw}});var s=Backbone.Model.extend({idAttribute:"_id",className:aD.LinkNodeModel,defaults:{_type:"LINK"},initialize:function(){this.id=_.uniqueId();this.uid=e(this.id,this.get("_type"));this.viewId="view-"+this.uid}});var aE=Backbone.Collection.extend({model:aq,baseUrl:ReportSettings.apiUrl,getByUID:function(bt){return this.find(function(bu){return bu.uid==bt})},parse:function(bt){return bt.list},multiplyFetch:function(bA,bv){var by=this;_.each(by.requests,function(bC){bC.abort()});by.requests=[];if(!bA.add){by.reset()}var bB=0;var bz=0;var bw=0;var bu=[];var bx=[];_.each(bv,function(bC){var bD=by.fetch({update:true,remove:false,url:bC.url,data:_.extend(bC.data,bA.data),error:function(bF,bE){bt(true,bE)},success:function(bF,bE){bt(false,bE)}});by.requests.push(bD)});function bt(bD,bC){bB++;if(bD){bz++;bu.push(bC)}else{bw++;bx.push(bC)}if(bB==bv.length){if(bz&&_.isFunction(bA.error)){bA.error.call(by,by,bu)}if(bw&&_.isFunction(bA.success)){bA.success.call(by,by,bx)}if(_.isFunction(bA.complete)){bA.complete.call(by,by,bu,bx)}}}return by.requests}});var aB=Backbone.Model.extend({MAX_TRACES_DEPTH:10,DEFAULT_TRACES_DEPTH:2,initialize:function(){var bt=this;bt.maxDepth=bt.DEFAULT_TRACES_DEPTH},setNodeModels:function(bu,bt){this.nodeModel1=bu;this.nodeModel2=bt},setRelationTypes:function(bt){this.relationTypes=bt},getMaxDepth:function(){return this.maxDepth},setMaxDepth:function(bt){this.maxDepth=bt},url:function(){var bt=this;var bu="";_.each(bt.relationTypes,function(bv){bu+=("&relType="+bv)});return ReportSettings.apiUrl+"/node/"+bt.nodeModel1.get("_type")+"/"+bt.nodeModel1.id+"/trace/"+bt.nodeModel2.get("_type")+"/"+bt.nodeModel2.id+"?maxDepth="+bt.maxDepth+bu}});var ao=Backbone.Model.extend({url:ReportSettings.apiUrl+"/users/me/info",hasPermissions:function(bu){for(var bt=0;bt<bu.length;bt++){if(!_.contains(this.get("permissions"),bu[bt])){return false}}return true}});var V=Backbone.View.extend({el:K.filter("#widget-view-template").html(),className:"widget-view",_codeTemplates:"",_isOpen:false,safeSpace:60,initialize:function(){var bt=this;bt.$parent=ae;bt._isOpen=false;bt.$el.hide().appendTo(bt.$parent).draggable({stop:function(){return bt._checkDrag()},handle:".widget-header, .widget-body-wrapper, .modal-footer",cancel:".widget-close, .widget-body"});bt.baseZIndex=parseInt(bt.$el.css("z-index"));bt.$el.css("z-index",bt.baseZIndex+$("."+bt.className).length);bt.$el.addClass(bt._codeTemplates.filter(".widget-view").attr("class"));bt._applyCode(".widget-header-label");bt.body=bt._applyCode(".widget-body");bt.footer=bt._applyCode(".widget-footer");bt.$actions=bt.$('[class^="action-"], [class*=" action-"]')},_applyCode:function(bw){var bu=this.$(bw);var bv=this._codeTemplates.filter(bw);bu.addClass(bv.attr("class"));var bt=bv.html();if(bt){bu.html(bv.html())}return bu},events:{"click .widget-close":"close","mousewheel":"_scroll","mousedown":"_bringToFront"},_abortRequest:function(){var bt=this;if(bt.request){bt.request.abort()}},_enabledActions:function(bt){var bu=this;if(bt){bu.$actions.removeClass("disabled").prop("disabled",false)}else{bu.$actions.addClass("disabled").prop("disabled",true)}},_checkDrag:function(){var bA=this;var by=bA.$el.offset().left;var bv=bA.$el.outerWidth();var bz=ah.scrollLeft();var bx=ah.outerWidth();var bB=bA.$el.offset().top;var bC=bA.$el.outerHeight();var bw=ah.scrollTop();var bt=ah.outerHeight();if(by+bv<bA.safeSpace+bz){bA.$el.css("left",bA.safeSpace-bv+"px")}else{if(by>bx-bA.safeSpace+bz){bA.$el.css("left",bx-bA.safeSpace+"px")}}var bu=ReportSettings.windowBounds.top;if(bB+bC+bu<bA.safeSpace+bw){bA.$el.css("top",bA.safeSpace-bC+bu+"px")}else{if(bB>bt-bA.safeSpace+bw){bA.$el.css("top",bt-bA.safeSpace+"px")}}bA.checkPosition()},_scroll:function(bx,bA,bw,bv){var by=this;var bu=ah.scrollTop();if(bv<0){var bB=by.$el.outerHeight();var bt=ah.outerHeight()-ReportSettings.footerHeight;if(by.$el.offset().top+bB>bt+bu){by.$el.css("top",by.$el.offset().top-bu+ReportSettings.effects.mousewheelStep*bv+"px");var bz=by.$el.offset().top;if(bz+bB<bt+bu){by.$el.css("top",by.$el.offset().top+bt-(bz+bB)+"px")}}}else{if(by.$el.offset().top<bu+ReportSettings.windowBounds.top){by.$el.css("top",by.$el.offset().top-bu+ReportSettings.effects.mousewheelStep*bv+"px");var bz=by.$el.offset().top;if(bz>ReportSettings.windowBounds.top){by.$el.css("top",by.$el.offset().top-bz+ReportSettings.windowBounds.top+"px")}}}return false},_bringToFront:function(){ReportUtils.bringToFront(this.$el,this.className,this.baseZIndex)},checkPosition:function(){var bv=this;if(bv.$el.css("left")=="-10000px"){var by=((ah.width()+ReportSettings.windowBounds.left-bv.$el.outerWidth())/2);var bx=0;bv.$el.css({"left":(by<ReportSettings.windowBounds.left?ReportSettings.windowBounds.left:by)+"px","top":(bx<ReportSettings.windowBounds.top?ReportSettings.windowBounds.top:bx)+"px"})}else{var by=parseInt(bv.$el.css("left").replace("px",""));var bx=parseInt(bv.$el.css("top").replace("px",""));var bt=bv.$el.outerHeight();var bu=ah.width();var bz=ah.height();var bw=ReportSettings.windowBounds.top;bv.$el.css({"left":by>bu?(bu-bv.safeSpace+"px"):bv.$el.css("left"),"top":bx>bz?(bz-bv.safeSpace+"px"):bx+bt<bw+bv.safeSpace?(bw+bv.safeSpace-bt+"px"):bv.$el.css("top")})}},open:function(){var bt=this;bt._bringToFront();bt.checkPosition();bt._isOpen=true;bt.trigger("onOpen",bt);bt.$el.fadeIn(ReportSettings.effects.duration)},close:function(){this._abortRequest();this._isOpen=false;this.trigger("onClose",this);this.$el.fadeOut(ReportSettings.effects.duration)},isOpen:function(){return this._isOpen}});var n=V.extend({_codeTemplates:$(K.filter("#open-report-widget-template").html()),initialize:function(bt){V.prototype.initialize.call(this);var bu=this;bu.reportList=new au();bu.$searchMessage=bu.$(".search-message").hide();bu.reportListView=new E({reportList:bu.reportList});bu.reportListView.on("onSelect",bu._onReportSelect,bu);bu.$reportsCnt=bu.$(".reports-cnt").append(bu.reportListView.$el).hide();bu.$openBtn=bu.$(".action-open")},events:function(){return _.extend({},V.prototype.events,{"click .refresh":"_getReports","click .action-open":"_openReport"})},_onReportSelect:function(bt,bv){var bu=this;bu.reportId=bt;bu.$openBtn.prop("disabled",false);if(bv.type=="dblclick"){bu._openReport()}},_openReport:function(){var bt=this;if(!br.checkPermissions(["REPORT_VIEW"])){return}var bu=bt.reportList.get(bt.reportId);T.showWait();bt.request=bu.fetch({error:function(bv,bw){T.showMessage(ReportUtils.getServerErrorMessage(bw.responseText),"error")},success:function(){T.hide({callBack:function(){bt.close();bt.trigger("onOpenReport",bu)}})}})},_getReports:function(){var bt=this;bt.$searchMessage.hide();bt.$reportsCnt.hide();bt.$openBtn.prop("disabled",true);if(!br.checkPermissions(["REPORT_LIST"])){bt.close();return}T.showWait();bt.request=bt.reportList.fetch({error:function(bv,bu){T.showMessage(ReportUtils.getServerErrorMessage(bu.responseText),"error")},success:function(){T.hide();if(bt.reportList.length==0){bt.$searchMessage.show()}else{bt.$reportsCnt.show();bt.reportListView.render()}}})},markedReportShared:function(bt,bu){this.reportListView.markedShared(bt,bu)},open:function(){V.prototype.open.call(this);this._getReports()}});var a5=null;var a=V.extend({_codeTemplates:$(K.filter("#save-as-report-widget-template").html()),initialize:function(bt){V.prototype.initialize.call(this);var bu=this;bu.$reportName=bu.$(".report-name");bu.$reportNameHelp=bu.$(".report-name-help").hide();bu.$reportName.bind("keydown","return",function(){bu._saveReport()})},events:function(){return _.extend({},V.prototype.events,{"click .action-save":"_saveReport"})},_saveReport:function(){var bt=this;var bu=$.trim(bt.$reportName.val());if(bu){bt.close();bt.options.reportView.saveReport({id:null,name:bu})}else{bt.$reportName.addClass("error")}},open:function(bv){V.prototype.open.call(this);var bt=this;bt.reportModel=bv;var bu=bv.get("name");if(bv.id){bu+=_i18n.Messages.report["page.title.sep"]+_i18n.Messages.report["new.name.copy"];bt.$reportNameHelp.show()}else{bt.$reportNameHelp.hide()}bt.$reportName.removeClass("error").val(bu).focus()}});var bi=null;var bg=V.extend({_codeTemplates:$(K.filter("#delete-report-widget-template").html()),initialize:function(bt){V.prototype.initialize.call(this);var bu=this;bu.$reportName=bu.$(".report-name")},events:function(){return _.extend({},V.prototype.events,{"click .action-delete":"_deleteReport"})},_getReportModel:function(){return this.options.reportView.reportModel},_deleteReport:function(){var bt=this;if(!br.checkPermissions(["REPORT_DELETE"])){return}var bu=bt._getReportModel();T.showWait();bt.request=bu.destroy({error:function(bv,bw){T.showMessage(ReportUtils.getServerErrorMessage(bw.responseText),"error")},success:function(){T.hide();bt.close();bt.trigger("onDeleteReport")}})},open:function(){V.prototype.open.call(this);var bt=this;var bu=bt._getReportModel();bt.$reportName.text(bu.get("name"))}});var a1=null;var j=V.extend({_codeTemplates:$(K.filter("#export-report-widget-template").html()),EXPORT_FORMAT:{"png":{settings:{dataKeys:["format","scale"],selector:".scale, .soft-info.png"}},"pdf":{settings:{dataKeys:["format","maxPageSize","cutDown"],selector:".max-page-size.pdf, .cutDown, .soft-info.pdf"}},"docx":{settings:{dataKeys:["format","maxPageSize","cutDown"],selector:".max-page-size.docx, .cutDown, .soft-info.docx"}}},DEFAULT_SCALE_PERCENT:100,MIN_SCALE_PERCENT:10,MAX_SCALE_PERCENT:400,DEFAULT_MAX_PAGE_SIZE:"A4",DEFAULT_CUTDOWN:false,initialize:function(bt){V.prototype.initialize.call(this);var bu=this;bu.exportData={reportId:null,format:null,scale:bu._percentToScale(bu.DEFAULT_SCALE_PERCENT),maxPageSize:bu.DEFAULT_MAX_PAGE_SIZE,cutDown:bu.DEFAULT_CUTDOWN};bu.$exportFormat=bu.$("select.export-format");bu.$scale=bu.$("input.scale").val(bu._scaleToPercent(bu.exportData.scale));_.each(bu.EXPORT_FORMAT,function(bw,bv){if(_.contains(bw.settings.dataKeys,"maxPageSize")){bu.$("."+bv+" select.max-page-size").find('option[value="'+bu.exportData.maxPageSize+'"]').prop("selected",true)}});bu.$cutDown=bu.$(".cutDown");bu.$cutDown.find('input[value="'+bu.exportData.cutDown+'"]').prop("checked",true);bu._showExportFormat(bu.$exportFormat.val())},events:function(){return _.extend({},V.prototype.events,{"click .action-save-report":"_doSaveReport","change select.export-format":"_onExportFormatChange","change input.scale":"_onScaleChange","click .action-export":"_doExport"})},_getReportModel:function(){return this.options.reportView.reportModel},_doSaveReport:function(){this.options.reportView._saveReport()},_onExportFormatChange:function(bt){this._showExportFormat($(bt.currentTarget).val())},_showExportFormat:function(bu){var bv=this;bv.exportData.format=bu;var bt=bv.EXPORT_FORMAT[bu].settings.selector;bv.$(".settings:not("+bt+")").hide();bv.$(".settings"+bt).show()},_scaleToPercent:function(bt){return Math.floor(bt*100)},_percentToScale:function(bt){return bt/100},_onScaleChange:function(){var bu=this;var bt=parseInt(bu.$scale.val());if(_.isNaN(bt)){bt=bu.DEFAULT_SCALE_PERCENT}if(bt<bu.MIN_SCALE_PERCENT){bt=bu.MIN_SCALE_PERCENT}else{if(bt>bu.MAX_SCALE_PERCENT){bt=bu.MAX_SCALE_PERCENT}}bu.$scale.val(bt);bu.exportData.scale=bu._percentToScale(bt)},_doExport:function(){var bv=this;if(!br.checkPermissions(["REPORT_EXPORT_IMAGE","REPORT_EXPORT_DOCX","REPORT_EXPORT_PDF"])){return}var bu=bv.exportData.format;bv._onScaleChange();bv.exportData=_.extend(bv.exportData,{maxPageSize:bv.$("."+bu+" select.max-page-size").val(),cutDown:bv.$cutDown.find("input:checked").val()});var bx=bv._getReportModel();var bw=bx.get("name");var bt=_.pick(bv.exportData,bv.EXPORT_FORMAT[bu].settings.dataKeys);bt.reportId=bx.id;aO(bw,bu,bt)}});var bs=null;var af=V.extend({_codeTemplates:$(K.filter("#add-node-widget-template").html()),initialize:function(bt){V.prototype.initialize.call(this);var bv=this;bv.reportView=bt.reportView;bv.nodeTypeSelectView=new o();bv.nodeTypeSelectView.on("change",bv._onNodeTypeChange,bv);var bu=null;aY.each(function(by,bx){var bw=by.toJSON();var bA=MetaUtils.getNodeType(bw.name);var bz=bv.nodeTypeSelectView.addOption();bz.text(bA.title).data("nodeType",bw);if(!bu){bu=bz}});bv.$(".node-type-select-view-cnt").append(bv.nodeTypeSelectView.$el);bv.nodePropertiesFilterView=new J({metaPref:"",metaTypes:MetaUtils.getNodeTypes()});bv.nodePropertiesFilterView.on("onSubmit",bv._doSearch,bv);bv.propertiesFilterCnt=bv.$(".node-properties-filter-cnt").append(bv.nodePropertiesFilterView.$el);bv.propertiesFilterExpand=bv.$(".properties-filter-expand");bv.addNodesView=new ab({selectNodes:false,reportView:br});bv.addNodesView.getRequestInfoList=$.proxy(bv._getRequestInfoList,bv);bv.addNodesView.on("onAddNode",bv._doAddNode,bv);bv.$(".search-nodes-cnt").html(bv.addNodesView.$el);bv.footer.hide();bv.nodeTypeSelectView.selectOption(bu)},events:function(){return _.extend({},V.prototype.events,{"click .clear-filter":"_clearFilter","click .properties-filter-expand":"_togglePropertiesFilterExpand"})},_doSearch:function(){this.addNodesView.searchNode()},_togglePropertiesFilterExpand:function(){var bt=this;if(bt.propertiesFilterCnt.hasClass("expanded")){bt.propertiesFilterCnt.removeClass("expanded");bt.propertiesFilterExpand.removeClass("icon-chevron-up").addClass("icon-chevron-down");bt.propertiesFilterCnt.slideUp(ReportSettings.effects.duration)}else{bt.propertiesFilterCnt.addClass("expanded");bt.propertiesFilterExpand.removeClass("icon-chevron-down").addClass("icon-chevron-up");bt.propertiesFilterCnt.slideDown(ReportSettings.effects.duration)}},_isPropertiesFilterOn:function(){return this.propertiesFilterCnt.hasClass("expanded")},_onNodeTypeChange:function(bu){var bt=this;bt.addNodesView.clear();bt.nodeType=bu.data("nodeType");bt.nodePropertiesFilterView.render([bt.nodeType])},_clearFilter:function(){var bt=this;bt.nodePropertiesFilterView.clearFilter([bt.nodeType])},_getRequestInfoList:function(){var bx=this;if(!br.checkPermissions(["SEARCH"])){return[{isValid:false,url:"",data:{}}]}var bz=true;var bu=bx._isPropertiesFilterOn();if(bu){var bt=bx.nodePropertiesFilterView.validateFilter([bx.nodeType])[bx.nodeType.name];if(bt.hasErrors){T.showMessage(_i18n.Messages.validation["search.params"],"error")}bz=!bt.hasErrors}var by=bx.nodePropertiesFilterView.getFilter([bx.nodeType],!bu)[bx.nodeType.name];var bv=[".exists"];var bw=0;_.each(by,function(bB,bA){_.each(bv,function(bC){if(bA.indexOf(bC,bA.length-bC.length)!==-1){bw++}})});if(_.isEmpty(by)||(_.size(by)==bw)){T.showMessage(_i18n.Messages.validation["search.params.empty"],"error");bz=false}return[{isValid:bz,url:"/nodes/"+bx.nodeType.name,data:bx.nodePropertiesFilterView.getFilter([bx.nodeType],!bu)[bx.nodeType.name]}]},_doAddNode:function(bt){this.trigger("onAddNode",bt)},close:function(){V.prototype.close.call(this);this.addNodesView.abortRequest()}});var aL=null;var I=Backbone.View.extend({tagName:"div",className:"individual-shortcut-view",template:_.template(K.filter("#individual-shortcut-view-template").html()),initialize:function(bt){var bu=this;br.on("reportChange",bu._onReportChange,bu)},events:{"click .filter-shortcut":"_doFilterShortcut"},render:function(by){var bv=this;if(!by||by.get("_type")!="INDIVIDUAL"){bv.nodeModel=null;bv.relationTypes=null;return bv}bv.nodeModel=by;var bu=br.getNodeInfo(bv.nodeModel.uid);var bw=bv._getInnInfoList(bu);if(bw.length==0){bv.$el.empty();return bv}bv.$el.html(bv.template({node:by.toJSON()}));var bt=bv.$(".list-item.sample").hide();_.each(bw,function(bB){var bA=bt.clone().removeClass("sample");var bz=bA.find(":first-child");bz.text(bB.inn).attr("data-filter-value",bB.inn).addClass(bB.inReport?"highlight":null);bA.insertBefore(bt).show()});bv.$listItems=bv.$(".list-item");var bx;if(bv.$activeListItem){bv.$listItems.each(function(){var bz=$(this);if(bz.text()===bv.$activeListItem.text()){bx=bz;return false}})}bv._setActiveItem(bx||bv.$listItems.filter(":not(.sample):first"));return bv},ReportActionsForRender:[a8.addNode,a8.addRelatedNode,a8.deleteNode,a8.update],_onReportChange:function(bv,bw){var bu=this;if(bu.nodeModel&&_.contains(bu.ReportActionsForRender,bv)){var bt=br.getNodeInfo(bu.nodeModel.uid);if(bt){bu.render(bt.view.model)}}},_getInnInfoList:function(bv){var bt={};var bu=_.pluck(aX(bv),"inn");H(bv.view.model,"children",function(bw){var bx=bw.inn;if(bx&&!_.has(bt,bx)){bt[bx]={inn:bx,inReport:_.contains(bu,bx)}}});return _.sortBy(_.values(bt),"inn")},_setActiveItem:function(bt){var bu=this;if(bt.is(bu.$activeListItem)){return}bu.$listItems.removeClass("active");bt.addClass("active");bu.$activeListItem=bt},_doFilterShortcut:function(bw){var bv=this;bw.preventDefault();var bt=$(bw.currentTarget);var bu=bt.parent();bv._setActiveItem(bu);bv.trigger("filterShortcut")},getFilter:function(){var bw=this;var bt=bw.$(".list-item.active > a");var bv={};var bu=bt.attr("data-filter-key");if(bu){bv[bu]=bt.attr("data-filter-value")}return bv},byRelationTypes:function(bt){var bu=this;bu.relationTypes=bt;bu.$el.attr("data-relation-types",_.pluck(bu.relationTypes,"name").join(" ").toLowerCase())},isRelationTypeSupport:function(bt){var bu=this;return _.contains(_.pluck(bu.relationTypes,"name"),bt.name)}});var b=Backbone.View.extend({tagName:"div",className:"company-info-view",template:_.template(K.filter("#company-info-view-template").html()),render:function(bu){var bt=this;if(!bu||bu.get("_type")!="COMPANY"){bt.nodeModel=null;bt.relationTypes=null;return bt}bt.nodeModel=bu;bt.$el.html(bt.template({node:bu.toJSON()}));return bt},byRelationTypes:function(bt){var bu=this;bu.relationTypes=bt;bu.$el.attr("data-relation-types",_.pluck(bu.relationTypes,"name").join(" ").toLowerCase())}});var aN=V.extend({_codeTemplates:$(K.filter("#add-related-nodes-widget-template").html()),initialize:function(bt){V.prototype.initialize.call(this);var bu=this;bu.relationInfo={relationType:null,nodeType:null,isSrcNode:true};var bv=bt.reportView;bv.on("onNodeViewsSelectChange",bu._onNodeViewsSelectChange,bu);bu.nodeView=new aH({addClasses:"highlight"});bu.nodeViewCnt=bu.$(".node-view-cnt");bu.relationTypeSelectView=new aR();bu.relationTypeSelectView.on("change",bu._onRelationTypeChange,bu);bu.$(".relation-type-select-view-cnt").append(bu.relationTypeSelectView.$el);bu.nodePropertiesFilterView=new J({metaPref:"node",metaTypes:MetaUtils.getNodeTypes()});bu.nodePropertiesFilterView.on("onSubmit",bu._doSearch,bu);bu.$(".node-properties-filter-cnt").html(bu.nodePropertiesFilterView.$el);bu.relationPropertiesFilterView=new J({metaPref:"rel",metaTypes:MetaUtils.getRelationTypes()});bu.relationPropertiesFilterView.on("onSubmit",bu._doSearch,bu);bu.$(".relation-properties-filter-cnt").html(bu.relationPropertiesFilterView.$el);bu.propertiesFilterCnt=bu.$(".properties-filter-cnt").append(bu.relationPropertiesFilterView.$el).append(bu.nodePropertiesFilterView.$el).hide();bu.propertiesFilterExpand=bu.$(".properties-filter-expand");bu.shortcutsCnt=bu.$(".shortcuts-cnt");bu.individualShortcutView=new I();bu.individualShortcutView.$el.appendTo(bu.shortcutsCnt);bu.individualShortcutView.on("filterShortcut",bu._doIndividualShortcut,bu);bu.byNodeTypeCnt=bu.$(".by-node-type-cnt");bu.companyInfoView=new b();bu.companyInfoView.$el.appendTo(bu.byNodeTypeCnt).hide();bu.egrulInfoView=new m();bu.egrulInfoView.$el.appendTo(bu.byNodeTypeCnt).hide();bu.egrulFounderIndividualsView=new z();bu.egrulFounderIndividualsView.$el.appendTo(bu.byNodeTypeCnt).hide();bu.egrulExecutiveIndividualsView=new ak();bu.egrulExecutiveIndividualsView.$el.appendTo(bu.byNodeTypeCnt).hide();bu.addNodesView=new ab({selectNodes:true,reportView:bv});bu.addNodesView.getRequestInfoList=$.proxy(bu._getRequestInfoList,bu);bu.addNodesView.getRelationInfo=$.proxy(bu._getRelationInfo,bu);bu.addNodesView.on("search-success",bu._onSearchSuccess,bu);bu.addNodesView.on("onAddNode",bu._doAddRelatedNode,bu);bu.$(".search-nodes-cnt").html(bu.addNodesView.$el);bu.footer.hide()},events:function(){return _.extend({},V.prototype.events,{"click .clear-filter":"_clearFilter","click .properties-filter-expand":"_togglePropertiesFilterExpand"})},render:function(bv){var bu=this;if(bu.nodeModel==bv&&!bv.hasChanged()){return bu}if(bv.className!=aD.NodeModel){bu.close();return bu}bu.nodeView.model=bv;bu.nodeView.render();bu.nodeViewCnt.html(bu.nodeView.$el);var bt=[];an.each(function(bx){var by=bx.toJSON();var bw=bv.get("_type");if(by.sourceNodeType==bw||by.destinationNodeType==bw){if(by.sourceNodeType==bw){bz(by,by.destinationNodeType,true)}if(by.destinationNodeType==bw){bz(by,by.sourceNodeType,false)}}function bz(bB,bA,bD){var bC={relationType:bB,nodeType:aY.getByName(bA).toJSON(),isSrcNode:bD};bt.push(bC)}});bu.nodeModel=bv;bu.relationTypeSelectView.showOptions(bt,true);bu.individualShortcutView.render(bu.nodeModel);bu.nodeType=bu.nodeModel.get("_type");bu.byNodeTypeCnt.attr("node-type",bu.nodeType);bu._byNodeType("render");bu.checkPosition();return bu},byNodeTypeSettings:{"COMPANY":{func:{render:function(){var bt=this;bt.shortcutsCnt.hide();bt.byNodeTypeCnt.hide();bt.companyInfoView.byRelationTypes(bt.relationTypes);bt.companyInfoView.$el.hide();bt.companyInfoView.render(bt.nodeModel);bt.egrulInfoView.$el.hide();bt.egrulInfoView.render(bt.nodeModel)},onRelationTypeChange:function(){var bt=this;bt.byNodeTypeCnt.hide();bt.companyInfoView.byRelationTypes(bt.relationTypes);bt.companyInfoView.$el.hide();bt.egrulInfoView.$el.hide()},onSearchSuccess:function(){var bt=this;bt.companyInfoView.$el.show();bt.egrulInfoView.$el.show();bt.byNodeTypeCnt.show()}}},"INDIVIDUAL":{func:{render:function(){var bt=this;bt.individualShortcutView.byRelationTypes(bt.relationTypes);bt.shortcutsCnt.show();bt.byNodeTypeCnt.hide();bt.egrulFounderIndividualsView.$el.hide();bt.egrulFounderIndividualsView.render(bt.nodeModel);bt.egrulExecutiveIndividualsView.$el.hide();bt.egrulExecutiveIndividualsView.render(bt.nodeModel)},onRelationTypeChange:function(){var bt=this;bt.individualShortcutView.byRelationTypes(bt.relationTypes);bt.byNodeTypeCnt.hide();bt.egrulFounderIndividualsView.$el.hide();bt.egrulExecutiveIndividualsView.$el.hide()},onSearchSuccess:function(){var bt=this;if(ReportUtils.isNoEgrulOrder(bt.nodeModel)){return}_.each(bt.relationTypes,function(bu){if(bu.name=="FOUNDER_INDIVIDUAL"){bt.egrulFounderIndividualsView.$el.show()}else{if(bu.name=="EXECUTIVE_INDIVIDUAL"){bt.egrulExecutiveIndividualsView.$el.show()}}});bt.byNodeTypeCnt.show()}}},"ADDRESS":{func:{render:function(){var bt=this;bt.shortcutsCnt.hide()}}},"PHONE":{func:{render:function(){var bt=this;bt.shortcutsCnt.hide()}}}},_byNodeType:function(bu){var bt=this;if(bt.byNodeTypeSettings[bt.nodeType]&&bt.byNodeTypeSettings[bt.nodeType].func[bu]){bt.byNodeTypeSettings[bt.nodeType].func[bu].call(bt)}},_doIndividualShortcut:function(){this._doSearch()},_doSearch:function(){this.addNodesView.searchNode()},_togglePropertiesFilterExpand:function(){var bt=this;if(bt.propertiesFilterCnt.hasClass("expanded")){bt.propertiesFilterCnt.removeClass("expanded");bt.propertiesFilterExpand.removeClass("icon-chevron-up").addClass("icon-chevron-down");bt.propertiesFilterCnt.slideUp(ReportSettings.effects.duration)}else{bt.propertiesFilterCnt.addClass("expanded");bt.propertiesFilterExpand.removeClass("icon-chevron-down").addClass("icon-chevron-up");bt.propertiesFilterCnt.slideDown(ReportSettings.effects.duration)}},_isPropertiesFilterOn:function(){return this.propertiesFilterCnt.hasClass("expanded")},_onNodeViewsSelectChange:function(bt){if(bt.length==1){this._clearFilter();this.addNodesView.clear();this.render(bt[0].model)}else{}},_onRelationTypeChange:function(bt){var bu=this;bu.relations=bt;bu._clearFilter();bu.addNodesView.clear();bu.nodeTypes=[];bu.relationTypes=[];bu.properties={};_.each(bt,function(bv){bu.nodeTypes.push(bv.relationInfo.nodeType);bu.relationTypes.push(bv.relationInfo.relationType);bu.properties[bv.relationInfo.relationType.name]=bv.relationTypeExt.properties});bu.nodePropertiesFilterView.render(bu.nodeTypes);bu.relationPropertiesFilterView.render(bu.relationTypes);bu.relationPropertiesFilterView.setFilter(bu.properties);bu._byNodeType("onRelationTypeChange");bu.checkPosition()},_clearFilter:function(){var bt=this;bt.nodePropertiesFilterView.clearFilter(bt.nodeTypes);bt.relationPropertiesFilterView.clearFilter(bt.relationTypes)},_getRequestInfoList:function(){var bv=this;if(!br.checkPermissions(["SEARCH_RELATED"])){return[{isValid:false,url:"",data:{}}]}var bw=[];var bu=false;var bt=bv._isPropertiesFilterOn();_.each(bv.relations,function(bx){var bE=true;var by=true;var bz=bv.nodePropertiesFilterView.isFilterOn(bx.relationInfo.nodeType);var bB=bv.relationPropertiesFilterView.isFilterOn(bx.relationInfo.relationType);if(bz){var bD=bv.nodePropertiesFilterView.validateFilter([bx.relationInfo.nodeType])[bx.relationInfo.nodeType.name];bE=!bD.hasErrors}if(bB){var bA=bv.relationPropertiesFilterView.validateFilter([bx.relationInfo.relationType])[bx.relationInfo.relationType.name];by=!bA.hasErrors}var bF=bE&&by;if(!bF){bu=true}var bC={};if(bv.individualShortcutView.isRelationTypeSupport(bx.relationInfo.relationType)){bC=bv.individualShortcutView.getFilter()}bw.push({isValid:bF,url:"/node/"+bv.nodeModel.id+"/"+bx.relationInfo.relationType.name+(bx.relationInfo.isSrcNode?"/children":"/parents"),data:_.extend({},bv.nodePropertiesFilterView.getFilter([bx.relationInfo.nodeType],!(bt&&bz))[bx.relationInfo.nodeType.name],bv.relationPropertiesFilterView.getFilter([bx.relationInfo.relationType],!(bt&&bB))[bx.relationInfo.relationType.name],bC)})});if(bu){T.showMessage(_i18n.Messages.validation["search.params"],"error")}return bw},_getRelationInfo:function(){var bt=this;if(bt.nodeView){return{relatedNode:bt.nodeView.model,relations:bt.relations}}return null},_onSearchSuccess:function(){this._byNodeType("onSearchSuccess")},_doAddRelatedNode:function(bv){var bu=this;var bt=[];_.each(bv,function(by){var bx={};var bw=_.find(bu.relations,function(bz){return bz.relationInfo.nodeType.name==by.get("_type")});bx.srcNodeModel=bw.relationInfo.isSrcNode?bu.nodeView.model:by;bx.dstNodeModel=bw.relationInfo.isSrcNode?by:bu.nodeView.model;bx.relationType=bw.relationInfo.relationType;bx.relationTypeExt=bw.relationTypeExt;bt.push(bx)});bu.trigger("onAddRelatedNode",bu.nodeView.model,bt)},open:function(bt){if(bt&&this.nodeModel!=bt){this._clearFilter();this.addNodesView.clear();this.render(bt)}V.prototype.open.call(this)},close:function(){V.prototype.close.call(this);this.addNodesView.abortRequest()}});var M=null;var v=V.extend({_codeTemplates:$(K.filter("#properties-widget-template").html()),initialize:function(bt){V.prototype.initialize.call(this);var bu=this;var bv=bt.reportView;bv.on("onNodeViewsSelectChange",bu._onNodeViewsSelectChange,bu);bu.nodeSimpleView=new aH({addClasses:"highlight"});bu.$(".node-simple-view-cnt").append(bu.nodeSimpleView.$el);bu.nodePropertiesView=new am();bu.$(".node-properties-view-cnt").append(bu.nodePropertiesView.$el)},events:function(){return _.extend({},V.prototype.events,{})},render:function(bt){var bu=this;if(bu.model==bt&&!bt.hasChanged()){return bu}if(bt.className==aD.NodeModel){bu.nodeSimpleView.model=bt;bu.nodeSimpleView.render();bu.nodePropertiesView.model=bt;bu.nodePropertiesView.render()}else{bu.close();return bu}bu.model=bt;bu.checkPosition();return bu},_onNodeViewsSelectChange:function(bt){if(bt.length==1){this.render(bt[0].model)}else{}},open:function(bt){if(bt){this.render(bt)}V.prototype.open.call(this)}});var aS=null;var bh=V.extend({_codeTemplates:$(K.filter("#delete-widget-template").html()),initialize:function(bt){V.prototype.initialize.call(this);var bu=this;var bv=bt.reportView;bv.on("onNodeViewsSelectChange",bu._onNodeViewsSelectChange,bu);bu.nodeSimpleView=new aH({addClasses:"highlight"});bu.$(".node-simple-view-cnt").append(bu.nodeSimpleView.$el);bu.$multiplyMessage=bu.$(".multiply-select-message").hide()},events:function(){return _.extend({},V.prototype.events,{"click .action-delete":"_doDelete"})},render:function(bu){var bt=this;bt.models=bu;if(bu.length>0){if(bu.length==1){bt.nodeSimpleView.model=bu[0];bt.nodeSimpleView.render();bt.nodeSimpleView.$el.show();bt.$multiplyMessage.hide()}else{bt.nodeSimpleView.$el.hide();bt.$multiplyMessage.show()}}else{bt.nodeSimpleView.$el.hide();bt.$multiplyMessage.hide();bt.close()}bt._enabledActions(bu.length>0);return bt},_onNodeViewsSelectChange:function(bt){var bu=[];_.each(bt,function(bv){if(bv.model.className==aD.NodeModel){bu.push(bv.model)}});this.render(bu)},_doDelete:function(){var bt=this;bt.trigger("delete",bt.models);bt.close()},open:function(bt){if(bt){this.render([bt])}V.prototype.open.call(this)}});var aw=null;var ad=V.extend({_codeTemplates:$(K.filter("#link-nodes-widget-template").html()),initialize:function(bt){V.prototype.initialize.call(this);var bu=this;bu.linkNodeModel=null;bu.nodeModelList=[];bu.reportView=bt.reportView;bu.reportView.on("onNodeViewsSelectChange",bu._onNodeViewsSelectChange,bu);bu.$nodeList=bu.$(".node-list");bu.$linkText=bu.$("textarea")},events:function(){return _.extend({},V.prototype.events,{"click .action-save":"_doSave"})},render:function(bt,bv){var bu=this;bu.linkNodeModel=bt;bu.nodeModelList=bv;bu.$nodeList.empty();_.each(bu.nodeModelList,function(bx){var bw=new aH({addClasses:"highlight"});bw.model=bx;bw.render();bu.$nodeList.append(bw.$el)});if(bu.linkNodeModel){bu.$linkText.val(bu.linkNodeModel.get("comment"))}else{bu.$linkText.val("")}bu.$linkText.focus();return bu},_onNodeViewsSelectChange:function(bt){if(bt.length>1){var bu=_.pluck(bt,"model");this.render(null,bu)}else{}},_doSave:function(){var bw=this;var bv=$.trim(bw.$linkText.val());if(bv){bw.close();var bt={comment:bv};var bu=null;if(bw.linkNodeModel){bw.linkNodeModel.set(bt);bu=bw.linkNodeModel}else{bu=new s(bt)}bw.reportView.linkNodes(bu,bw.nodeModelList)}else{bw.$linkText.addClass("error")}},edit:function(bt,bu){this.render(bt,bu);this.open()},open:function(){V.prototype.open.call(this);this.$linkText.val("").focus()}});var a6=null;var aa=ad.extend({_codeTemplates:$(K.filter("#link-nodes-edit-widget-template").html()),_onNodeViewsSelectChange:function(bt){},openEdit:function(bt,bu){this.render(bt,bu);this.open()},open:function(){V.prototype.open.call(this);this.$linkText.focus()}});var l=null;var aJ=ad.extend({_codeTemplates:$(K.filter("#link-nodes-delete-widget-template").html()),_onNodeViewsSelectChange:function(bt){},events:function(){return _.extend({},V.prototype.events,{"click .action-delete":"_doDelete"})},_doDelete:function(bt,bu){this.close();this.trigger("doDelete",this.linkNodeModel)},openDelete:function(bt,bu){this.render(bt,bu);this.open()},open:function(){V.prototype.open.call(this)}});var C=null;var r=V.extend({_codeTemplates:$(K.filter("#search-relation-widget-template").html()),relationTypeFilterTemplate:_.template(K.filter("#search-relation-relation-type-filter-template").html()),resultTemplate:_.template(K.filter("#search-relation-result-template").html()),initialize:function(bt){V.prototype.initialize.call(this);var bw=this;bt.reportView.on("onNodeViewsSelectChange",bw._onNodeViewsSelectChange,bw);bw.traceResultModel=new aB();bw.nodeSimpleView1=new aH({addClasses:"highlight"});bw.$(".node-simple-view-cnt-1").append(bw.nodeSimpleView1.$el);bw.nodeSimpleView2=new aH({addClasses:"highlight"});bw.$(".node-simple-view-cnt-2").append(bw.nodeSimpleView2.$el);var bv=[];_.each(MetaUtils.getRelationTypes(),function(by,bx){bv.push({name:bx,properties:by})});bv=_.sortBy(bv,function(bx){return bx.properties.order});bw.$relationTypeFilter=bw.$(".relation-type-filter").html(bw.relationTypeFilterTemplate({relationInfoList:bv}));bw.$depth=bw.$(".search-relation-depth");bw.$depth.empty();for(var bu=1;bu<=bw.traceResultModel.MAX_TRACES_DEPTH;bu++){bw.$depth.append($("<option/>",{text:bu,value:bu,selected:bw.traceResultModel.getMaxDepth()==bu}))}bw.$result=bw.$(".result").hide();bw.footer.hide()},events:function(){return _.extend({},V.prototype.events,{"change .relation-type-filter .relation-type-entry input":"_onRelationTypeFilterChange","click .search":"_search","click .do-result":"_doResult"})},render:function(bv,bu){var bt=this;bt.$result.hide();if((bt.model1==bv&&!bv.hasChanged())&&(bt.model2==bu&&!bu.hasChanged())){return bt}if(bv.className!=aD.NodeModel||bu.className!=aD.NodeModel){bt.close();return bt}bt.traceResultModel.setNodeModels(bv,bu);bt.nodeSimpleView1.model=bv;bt.nodeSimpleView1.render();bt.nodeSimpleView2.model=bu;bt.nodeSimpleView2.render();bt.model1=bv;bt.model2=bu;return bt},_onNodeViewsSelectChange:function(bt){if(bt.length==2){this.render(bt[0].model,bt[1].model)}else{}},_onRelationTypeFilterChange:function(bv){var bt=this;var bu=bt.$relationTypeFilter.find("input:checked");bu.prop("disabled",bu.length==1)},_search:function(){var bu=this;if(!br.checkPermissions(["SEARCH_TRACES"])){return}var bt=[];bu.$relationTypeFilter.find("input:checked").each(function(){bt.push($(this).attr("relation-type-name"))});bu.traceResultModel.clear();bu.traceResultModel.setRelationTypes(bt);bu.traceResultModel.setMaxDepth(bu.$depth.val());bu.$result.hide();T.showWait();bu.request=bu.traceResultModel.fetch({error:function(bv,bw){T.showMessage(ReportUtils.getServerErrorMessage(bw.responseText),"error")},success:function(bw,bv){bu.$result.html(bu.resultTemplate({traceResult:bu.traceResultModel.toJSON()})).show();T.hide()}})},_doResult:function(){this.trigger("onSearchRelation",this.traceResultModel)}});var aV=null;var aA=V.extend({_codeTemplates:$(K.filter("#note-widget-template").html()),noteKey:"note",initialize:function(bt){V.prototype.initialize.call(this);var bu=this;bu.reportView=bt.reportView;bu.reportView.on("onDeleteNode",bu._onDeleteNode,bu);bu.$noteText=bu.$("textarea");bu.nodeSimpleView=new aH({addClasses:"highlight"});bu.$nodeSimpleCiewCnt=bu.$(".node-simple-view-cnt").append(bu.nodeSimpleView.$el).hide();bu.srcNodeSimpleView=new aH({addClasses:"highlight"});bu.$srcNodeSimpleViewCnt=bu.$(".src-node-simple-view-cnt").append(bu.srcNodeSimpleView.$el).hide();bu.$relationView=bu.$(".relation-view");bu.dstNodeSimpleView=new aH({addClasses:"highlight"});bu.$dstNodeSimpleViewCnt=bu.$(".dst-node-simple-view-cnt").append(bu.dstNodeSimpleView.$el).hide()},events:function(){return _.extend({},V.prototype.events,{"click .action-save":"_doSave"})},_onDeleteNode:function(){var bt=this;bt.objectInfo=null;bt.close()},_doSave:function(){var bu=this;if(bu.objectInfo){var bt=$.trim(bu.$noteText.val());bu.objectInfo[bu.noteKey]=bt;bu.objectInfo.view.showNote(bt)}bu.close();bu.reportView._reportChange(a8.objectNote)},_editNodeNote:function(bt){var bu=this;bu.nodeSimpleView.model=bt.nodeModel;bu.nodeSimpleView.render();bu.$nodeSimpleCiewCnt.show()},_editRelationNote:function(bt){var bu=this;bu.srcNodeSimpleView.model=bt.srcNodeModel;bu.srcNodeSimpleView.render();bu.dstNodeSimpleView.model=bt.dstNodeModel;bu.dstNodeSimpleView.render();bu.$srcNodeSimpleViewCnt.show();bu.$relationView.show();bu.$dstNodeSimpleViewCnt.show()},editNote:function(bu,bt){var bv=this;bv.objectInfo=null;bv.$nodeSimpleCiewCnt.hide();bv.$srcNodeSimpleViewCnt.hide();bv.$relationView.hide();bv.$dstNodeSimpleViewCnt.hide();if(bu=="NODE"){bv._editNodeNote(bt)}else{if(bu=="RELATION"){bv._editRelationNote(bt)}else{throw new Error("Unsupported note type")}}bv.objectInfo=bt.objectInfo;bv.$noteText.val(bv.objectInfo[bv.noteKey]);bv.open();bv.$noteText.focus()}});var al=null;var E=Backbone.View.extend({tagName:"div",className:"report-list-view",template:_.template(K.filter("#report-list-view-template").html()),initialize:function(bt){var bu=this;bu.reportList=bt.reportList;bu.selectReportId=null},events:{"click .report-list-entry":"_onRowClick","dblclick .report-list-entry":"_onRowDblClick","click .report-action-more-info":"_toogleReportMoreInfo"},_isNoEvent:function(bt){return $(bt).is(".report-action, .report-action *, .report-tool, .report-tool *")},_onRowClick:function(bt){if(this._isNoEvent(bt.target)){return}this._doSelect(bt)},_onRowDblClick:function(bt){if(this._isNoEvent(bt.target)){return}this._doSelect(bt)},_toogleReportMoreInfo:function(bv){var bu=this;var bt=$(bv.currentTarget).parents(".report-list-entry");if(bt.hasClass("expanded")){bt.removeClass("expanded").find(".more-info").slideUp(ReportSettings.effects.duration)}else{bt.addClass("expanded").find(".more-info").slideDown(ReportSettings.effects.duration)}},_doSelect:function(bv){var bu=this;var bt=$(bv.currentTarget);bu.$rows.removeClass("selected");bt.addClass("selected");bu.selectReportId=bt.attr("report-id");bu.trigger("onSelect",bu.selectReportId,bv)},render:function(){var bt=this;bt.$el.html(bt.template({reportList:bt.reportList.toJSON()}));bt.$rows=bt.$(".report-list-entry");at(bt.$rows,true,'.not-select, .not-select *, .more-info-entry-label, .more-info-entry-label *, .more-info-entry-value:not(".can-select"), .more-info-entry-value:not(".can-select") *');bt.$(".report-share-widget").click(function(bu){bu.stopPropagation()});bt.$(".report-shared-checkbox").change(function(bx){var bv=$(bx.currentTarget);var bw=bv.is(":checked");var bu=bv.parents(".report-list-entry").attr("report-id");bt._doShared(bu,bw)});bt.$(".report-share-url").bind("focus click",function(){var bu=$(this);bu.select();bu.mouseup(function(){bu.unbind("mouseup");return false})});return bt},_doShared:function(bt,bv){var bu=this;var bw=bu.reportList.get(bt);T.showWait();bw.partialSave({shared:bv},{error:function(bx,by){T.showMessage(ReportUtils.getServerErrorMessage(by.responseText),"error")},success:function(){bu.markedShared(bt,bv);if(bt===br.getReportId()){br.markedShared(bv)}T.hide()}})},markedShared:function(bz,bw){var by=this;if(!by.$rows){return}var bx=by.$rows.filter('[report-id="'+bz+'"]');if(!bx){return}var bB=bx.find(".report-share-cnt");var bu=bx.find(".report-share");var bt=bx.find(".report-share-widget");var bC=bx.find(".report-share-url");if(bw){bB.removeClass("cant-shared");bu.addClass("success");bt.addClass("shared")}else{bu.removeClass("success");bt.removeClass("shared")}var bA=by.reportList.get(bz);var bv=bA.get("shareKey");bC.val(bv?ReportUtils.buildReportShareUrl(bv):"")}});var o=Backbone.View.extend({el:K.filter("#select-view-template").html(),SelectEntryView:Backbone.View.extend({el:K.filter("#select-entry-view-template").html(),initialize:function(bt){var bu=this;bu.$option=bu.$(".select-option")}}),initialize:function(bt){var bu=this;bu.$list=bu.$(".select-list");bu.$selectText=bu.$(".select-text")},events:{"click .select-option":"_onOptionClick"},_onOptionClick:function(bt){this.selectOption($(bt.currentTarget))},selectOption:function(bu){var bt=this;if(bt.$selectedOption&&bt.$selectedOption[0]==bu[0]){return}bt.$(".select-option").removeClass("selected");bu.addClass("selected");bt.$selectText.text(bu.text());bt.$selectedOption=bu;bt.trigger("change",bu)},addOption:function(){var bt=this;entryView=new bt.SelectEntryView();bt.$list.append(entryView.$el);return entryView.$option},empty:function(){this.$list.empty()}});var aR=Backbone.View.extend({tagName:"div",className:"select-view relation-type-select-view",template:_.template(K.filter("#relation-type-select-view-template").html()),initialize:function(bt){var bu=this;bu.$el.html(bu.template({}));bu.$entries=bu.$(".relation-entry");bu.$options=bu.$(".relation-info");bu.options=[];bu.$options.each(function(){var bw=$(this);var bv=MetaUtils.getRelationTypeExt(bw.attr("relationTypeExtName"));bw.data("relationTypeExt",bv);bu.options.push(bw)});bu.selectText=bu.$(".select-text")},events:{"click .relation-info":"_onOptionClick"},_onOptionClick:function(bt){this._doSelect($(bt.currentTarget))},_doSelect:function(bv){var bw=this;var bu=bv.data("relationTypeExt");if(_.isEqual(bw.selectedRelationTypeExt,bu)){return}bw.$options.removeClass("selected");bv.addClass("selected");bw.selectText.text(bu.findTitle);bw.selectedRelationTypeExt=bu;var bt=[];if(bu.baseRelationTypeName){bt.push({relationTypeExt:bu,relationInfo:bv.data("relationInfo")})}else{function bx(by){_.each(by,function(bA){if(bA.baseRelationTypeName){var bz=_.find(bw.options,function(bB){return bB.data("relationTypeExt").name==bA.name});bt.push({relationTypeExt:bA,relationInfo:bz.data("relationInfo")})}else{bx(bA.relationTypes)}})}bx(bu.relationTypes)}bw.trigger("change",bt)},showOptions:function(bw,bx){var bv=this;bv.$entries.hide();var bu=null;_.each(bv.options,function(bz){var by=bz.data("relationTypeExt");if(by.baseRelationTypeName){var bA=_.find(bw,function(bB){return(bB.relationType.name==by.baseRelationTypeName&&bB.isSrcNode==!by.parents)});if(bA){bz.parents(".relation-entry").show();if(!bu){bu=bz}}bz.data("relationInfo",bA)}});if(bu&&bx){var bt=bu.parents(".relation-entry");bv._doSelect($(bt[bt.length-1]).children(".relation-info"))}}});var ab=Backbone.View.extend({el:K.filter("#add-nodes-view-template").html(),selectedNodeViews:[],selectNodes:false,pagingInfoTemplate:_.template(K.filter("#paging-info-template").html()),initialize:function(bt){var bu=this;bu.reportView=bt.reportView;bu.nodeList=new aE(),bu.nodeList.comparator=function(bv){return MetaUtils.getNodeType(bv.get("_type")).order};bu.selectedNodeViews=[];bu.selectNodes=bt.selectNodes;bu.searchMessage=bu.$(".search-message").hide();bu.nodeListWrapper=bu.$(".node-list-wrapper").hide();bu.nodeListCnt=bu.$(".node-list");bu.nodeListWrapper.append(bu.nodeListCnt);bu.navToolbar=bu.$(".nav-toolbar").hide();bu.addNodeBtn=bu.$(".add-node");bu.prevPageBtn=bu.$(".prev-page");bu.nextPageBtn=bu.$(".next-page");bu.$navInfo=bu.$(".nav-toolbar .info")},events:{"click .search-node":"_searchClick","click .prev-page":"_prevPageClick","click .next-page":"_nextPageClick","click .add-node":"_doAddNode"},_searchClick:function(){this.searchNode()},_prevPageClick:function(){this.pageConfig.page--;this._doSearchNode()},_nextPageClick:function(){this.pageConfig.page++;this._doSearchNode()},_checkPaging:function(bu){var bv=this;var bt=_.max(bu,function(bw){return bw.pageCount});bv.prevPageBtn.prop("disabled",bt.pageNumber==1);bv.nextPageBtn.prop("disabled",bt.pageNumber==bt.pageCount)},_doSearchNode:function(bw){var bu=this;var bv=bu.getRequestInfoList();var bt=true;_.each(bv,function(bx){bx.url=bu.nodeList.baseUrl+bx.url;if(!bx.isValid){bt=false}});if(!bt){return}bu.clear();T.showWait();bu.selectedNodeViews=[];bu.requests=bu.nodeList.multiplyFetch({data:bu.pageConfig,error:function(by,bx){T.showMessage(ReportUtils.getServerErrorMessage(bx[0].responseText),"error")},success:function(bA,bz){bu._checkPaging(bz);if(bu.nodeList.length==0){bu.searchMessage.show()}else{var by=bu._getRelationMap(bu.getRelationInfo(),bu.nodeList.models);bu.nodeList.each(function(bD){var bC=bu.reportView.isNodeExists(bD);var bB=new bj({model:bD,selectable:!bC,selected:bC||bu.selectNodes,addClasses:bC?"report-exists":null,relationData:by[bD.uid]});bB.render();bB.on("onSelectChange",bu._onNodeViewSelectChange,bu);bu.nodeListCnt.append(bB.$el);if(!bC&&bu.selectNodes){bu.selectedNodeViews.push(bB)}});var bx=false;_.each(bz,function(bB){if(bB.pageCount>1){bx=true}});bu.nodeListWrapper.show();if(bx){bu._showInfo(bA,bz);bu.navToolbar.show()}else{bu.navToolbar.hide()}bu.addNodeBtn.show().prop("disabled",bu.selectedNodeViews.length<1)}bu.trigger("search-success")},complete:function(by,bz,bx){if(bz.length==0){T.hide()}}},bv)},_getRelationMap:function(bw,bu){var bt={};if(!bw){return bt}var bv=bw.relatedNode;_.each(bu,function(bA){var bx=bA.uid;var bz=bt[bx];if(!bz){bt[bx]={relations:[]};bz=bt[bx]}var by=_.find(bw.relations,function(bB){return bB.relationInfo.nodeType.name==bA.get("_type")});_.each(bA.get("_relations"),function(bC){var bB;if(bA.uid===bv.uid){if(bC._srcId===bv.id&&bC._dstId===bC._srcId){bB=bC}}else{if(by.relationInfo.isSrcNode){if(bC._srcId===bv.id){bB=bC}}else{if(bC._dstId===bv.id){bB=bC}}}if(bB){bz.relations.push({relation:bB,relationTypeMeta:MetaUtils.getRelationType(bB._type)})}})});_.each(bt,function(by){var bx=_.sortBy(by.relations,function(bz){return bz.relationTypeMeta.order});by.relations=bx});return bt},_onNodeViewSelectChange:function(bt){var bu=bt.model.uid;if(bt.selected){this.selectedNodeViews=_.union(this.selectedNodeViews,[bt])}else{this.selectedNodeViews=_.without(this.selectedNodeViews,bt)}this.addNodeBtn.prop("disabled",!this.selectedNodeViews.length)},_doAddNode:function(){var bt=this;var bu=[];_.each(bt.selectedNodeViews,function(bv){bu.push(bv.model);bv.$el.addClass("report-exists");bv.selectable=false});bt.selectedNodeViews=[];bt.addNodeBtn.prop("disabled",true);bt.trigger("onAddNode",bu)},_showInfo:function(bw,bv){var by=this;var bx=0;var bt=0;var bA=0;var bB=by.pageConfig.page;var bz=0;var bu=0;var bC=0;_.each(bv,function(bD){if(bD.pageNumber<=bD.pageCount){bz+=bD.pageSize;bu+=_.size(bD.list)}else{bC+=bD.total}bA+=bD.total});bx=(bB-1)*bz+1+bC;bt=(bB-1)*bz+bu+bC;by.$navInfo.html(by.pagingInfoTemplate({firstNumber:bx,lastNumber:bt,total:bA}))},clear:function(){this.abortRequest();this.searchMessage.hide();this.navToolbar.hide();this.nodeListWrapper.hide();this.nodeListCnt.empty();this.addNodeBtn.hide().prop("disabled",true)},getRequestInfoList:function(){return[{isValid:true,url:"",data:{}}]},getRelationInfo:function(){return null},searchNode:function(){this.pageConfig={page:1,pageSize:ReportSettings.paging.pageSize};this._doSearchNode()},abortRequest:function(){_.each(this.requests,function(bt){bt.abort()})}});var k=Backbone.View.extend({tagName:"div",propertyMeta:{},initialize:function(bt){this.propertyMeta=bt.propertyMeta;this.defaultValues=[]},events:{"click .property-label":"_focusInput"},render:function(){var bt=this;bt.$el.html(bt.template({propertyMeta:bt.propertyMeta}));return bt},_focusInput:function(){this.focusInput.focus()},setValues:function(bt){var bu=this;var bv=_.isArray(bt);_.each(bu.inputs,function(bw,bx){bw.val(bv&&bx<bt.length?bt[bx]:"")})},resetValues:function(){this.setValues(this.defaultValues)},setDefaultFilter:function(bu){var bt=this;bt.defaultValues=bu;bt.setValues(bu)},getDefaultFilter:function(){return this.getFilter(this.defaultValues)},getFilter:function(bt){throw new Error("Unsupported operation")},getValidationRules:function(){var bt=this;var bu={};if(bt.propertyMeta.validation){bu[bt.propertyMeta.name]=bt.propertyMeta.validation.rule}return bu}});var bn=k.extend({className:"property-filter contains-filter-view",template:_.template(K.filter("#contains-filter-view-template").html()),render:function(){k.prototype.render.call(this);var bt=this;bt.input=bt.$(".input");bt.inputs=[bt.input];bt.focusInput=bt.input;return bt},getFilter:function(bt){var bv=this;var bx=_.isArray(bt);var bu={};var bw=bx?bt[0]:$.trim(bv.input.val());if(bx||bw){bu[bv.propertyMeta.name+".contains"]=bw}return bu}});var c=k.extend({className:"property-filter equals-filter-view",template:_.template(K.filter("#equals-filter-view-template").html()),render:function(){k.prototype.render.call(this);var bt=this;bt.input=bt.$(".input");bt.inputs=[bt.input];bt.focusInput=bt.input;return bt},getFilter:function(bt){var bv=this;var bx=_.isArray(bt);var bu={};var bw=bx?bt[0]:$.trim(bv.input.val());if(bx||bw){bu[bv.propertyMeta.name+".equals"]=bw}return bu}});var h=k.extend({className:"property-filter exists-filter-view",template:_.template(K.filter("#exists-filter-view-template").html()),render:function(){k.prototype.render.call(this);var bt=this;bt.input=bt.$(".input");bt.inputs=[bt.input];return bt},getFilter:function(bt){var bv=this;var by=_.isArray(bt);var bu={};var bw=by?bt[0]:bv.input.is(":checked");if(bw){var bx=bv.propertyMeta.filter.options;bu[bv.propertyMeta.name+".exists"]=bx.reverse?!bw:bw}return bu}});var bc=k.extend({className:"property-filter range-filter-view",template:_.template(K.filter("#range-filter-view-template").html()),render:function(){k.prototype.render.call(this);var bt=this;bt.inputMin=bt.$(".input-min");bt.inputMax=bt.$(".input-max");bt.inputs=[bt.inputMin,bt.inputMax];bt.focusInput=bt.inputMin;return bt},getFilter:function(bu){var bx=this;var by=_.isArray(bu);var bv={};var bw=by?bu[0]:$.trim(bx.inputMin.val());if(by||bw){bv[bx.propertyMeta.name+".min"]=bw}var bt=by?bu[1]:$.trim(bx.inputMax.val());if(by||bt){bv[bx.propertyMeta.name+".max"]=bt}return bv},getValidationRules:function(){var bu=k.prototype.getValidationRules.call(this);var bt=this;var bv={};_.each(bu,function(bx,bw){bv[bw+".min"]=bx;bv[bw+".max"]=bx});return bv}});var J=Backbone.View.extend({tagName:"div",className:"properties-filter-view",propertyFilterViews:{"CONTAINS":bn,"EQUALS":c,"EXISTS":h,"RANGE":bc},metaPref:"",metaTypes:{},metaTypeViews:{},initialize:function(bt){var bu=this;bu.metaPref=bt.metaPref;bu.metaTypes=bt.metaTypes;bu.metaTypeViews={};_.each(bu.metaTypes,function(bx,bw){var bv=new a3({metaType:bx});bu.metaTypeViews[bw]={typeView:bv,filterViews:[]};bu.$el.append(bv.$el)})},render:function(bv){var bu=this;var bt=bv.length;bu.$el.children().hide();_.each(bv,function(bD){var bz=bD.name;var bC=bD.properties;var bx=bu.metaTypeViews[bz];if(bx.filterViews.length){bx.typeView.showHeader(bt>1);bx.typeView.$el.show()}else{var bB=[];var by={};_.each(bu.metaTypes[bz].properties,function(bG){if(bG.filter){var bF=_.find(bC,function(bH){return bG.name==bH.name});var bE=new bu.propertyFilterViews[bG.filter.type]({propertyMeta:bG});bE.render();bx.typeView.showHeader(bt>1);bx.typeView.$el.show();bx.typeView.$filterViewList.append(bE.$el);bB.push(bE);_.extend(by,bE.getValidationRules())}});bx.filterViews=bB;var bw=bx.typeView;bw.getForm().submit(function(){return false}).find("input").attr("autocomplete","off").bind("keydown keypress keyup",function(bE){if(bE.keyCode==13){if(bE.type=="keyup"){bu.trigger("onSubmit",bu)}return false}});var bA=bw.getForm().validate({rules:by,onfocusout:false,onkeyup:false,onclick:false,focusInvalid:false,onsubmit:true,errorElement:"span",errorPlacement:function(bE,bF){return false},submitHandler:function(bE){return false}});bx.validator=bA}})},clearFilter:function(bu){var bt=this;if(_.isArray(bu)){_.each(bu,function(bw){var bv=bw.name;_.each(bt.metaTypeViews[bv].filterViews,function(bx){bx.resetValues()})})}},isFilterOn:function(bt){return this.metaTypeViews[bt.name].typeView.isFilterOn()},setFilter:function(bt){var bu=this;_.each(bt,function(bw,bv){_.each(bu.metaTypeViews[bv].filterViews,function(bx){var by=bw?bw[bx.propertyMeta.name]:undefined;bx.setDefaultFilter(by?by.values:undefined)})})},getFilter:function(bw,bt){var bv=this;var bu={};_.each(bw,function(by){var bx=by.name;bu[bx]={};_.each(bv.metaTypeViews[bx].filterViews,function(bz){_.each(bt?bz.getDefaultFilter():bz.getFilter(),function(bA,bB){bu[bx][(bv.metaPref?bv.metaPref+".":"")+bB]=bA})})});return bu},validateFilter:function(bv){var bu=this;var bt={};_.each(bv,function(bA){var bx=bA.name;bt[bx]={hasErrors:false};var bw=bu.metaTypeViews[bx];var by=bw.validator;ai($(by.currentForm));var bz=by.form();if(!bz){bt[bx].hasErrors=true}});return bt}});var a3=Backbone.View.extend({tagName:"div",className:"meta-type-properties-filter-view",template:_.template(K.filter("#meta-type-properties-filter-view-template").html()),initialize:function(bt){var bu=this;bu.metaType=bt.metaType;bu.$el.html(bu.template({metaType:bu.metaType}));bu.$form=bu.$("form");bu.$header=bu.$(".meta-type-header");bu.$filterViewListExpand=bu.$(".filter-view-list-expand");bu.$filterViewList=bu.$(".filter-view-list")},events:{"click .filter-view-list-expand":"_toggleFilterViewListExpand"},_toggleFilterViewListExpand:function(){var bt=this;if(bt.$filterViewList.hasClass("expanded")){bt._doFilterViewListExpand(false,true)}else{bt._doFilterViewListExpand(true,true)}},_doFilterViewListExpand:function(bu,bt){var bv=this;if(bu){bv.$filterViewList.addClass("expanded");bv.$filterViewListExpand.removeClass("icon-chevron-down").addClass("icon-chevron-up");if(bt){bv.$filterViewList.slideDown(ReportSettings.effects.duration)}else{bv.$filterViewList.show()}}else{bv.$filterViewList.removeClass("expanded");bv.$filterViewListExpand.removeClass("icon-chevron-up").addClass("icon-chevron-down");if(bt){bv.$filterViewList.slideUp(ReportSettings.effects.duration)}else{bv.$filterViewList.hide()}}},isFilterOn:function(){return this.$filterViewList.hasClass("expanded")},getForm:function(){return this.$form},showHeader:function(bt){var bu=this;if(bt){bu.$header.show()}else{bu._doFilterViewListExpand(true,false);bu.$header.hide()}}});var aH=Backbone.View.extend({model:aq,tagName:"div",className:"node-simple-view",template:_.template(K.filter("#node-simple-view-template").html()),initialize:function(bt){var bu=this;bu.$el.addClass(bt.addClasses)},render:function(){var bt=this;bt.$el.html(bt.template({node:bt.model.toJSON()})).addClass(bt.model.get("_type").toLowerCase());return bt}});var bj=Backbone.View.extend({model:aq,tagName:"div",className:"node-plain-view",template:_.template(K.filter("#node-plain-view-template").html()),selectable:false,selected:false,initialize:function(bt){var bu=this;bu.selectable=bt.selectable;if(bu.selectable){bu.$el.addClass("selectable");bu.selected=bt.selected;if(bu.selected){bu.$el.addClass("selected")}}bu.$el.addClass(bt.addClasses);bu.relationData=bt.relationData},events:{"click":"_toggleSelect","click .node-actions .more-info":"_toggleMoreInfo"},render:function(){var bt=this;bt.$el.html(bt.template({nodeModel:bt.model,node:bt.model.toJSON(),relationData:bt.relationData})).addClass(bt.model.get("_type").toLowerCase()).addClass(L(bt.model));bt.expandCnt=bt.$(".expand-cnt").hide();bt.moreInfoAction=bt.$(".node-actions .more-info");return bt},_toggleSelect:function(){var bt=this;if(!bt.selectable){return}if(bt.$el.hasClass("selected")){bt.$el.removeClass("selected");bt.selected=false}else{bt.$el.addClass("selected");bt.selected=true}bt.trigger("onSelectChange",bt)},_toggleMoreInfo:function(){var bt=this;if(bt.$el.hasClass("expanded")){bt.$el.removeClass("expanded");bt.moreInfoAction.removeClass("icon-chevron-up").addClass("icon-chevron-down");bt.expandCnt.slideUp(ReportSettings.effects.duration)}else{bt.$el.addClass("expanded");bt.moreInfoAction.removeClass("icon-chevron-down").addClass("icon-chevron-up");bt.expandCnt.slideDown(ReportSettings.effects.duration)}return false}});var aM=Backbone.View.extend({viewClassName:bq.NodeGraphView,model:aq,tagName:"div",className:aj,template:_.template(K.filter("#node-graph-view-template").html()),theme:ObjectTheme.defaultThemeName,initialize:function(bt){var bu=this;bu.reportView=bt.reportView},noteKey:"note",events:{"mousedown":"_onMousedown","click":"_onClick","dblclick":"_onDblClick","mouseenter":"_onMouseEnter","mouseleave":"_onMouseLeave","click .node-action-add-related-nodes":"_onAddRelatedNodes","click .node-action-delete":"_onDelete","click .node-action-properties":"_onProperties","click .node-action-comment":"_onComment","click .node-action-note":"_onNote","click .node-action-to-new-report":"_onToNewReport"},render:function(bt,bv){var bu=this;bu.id=bu.model.viewId;bu.$el.html(bu.template({nodeModel:bu.model,node:bu.model.toJSON(),reportView:bu.reportView,_commentOptions:W})).attr("id",bu.id).addClass(bu.model.get("_type").toLowerCase()).addClass(L(bu.model)).css({"left":"0px","top":"0px"});if(bt){bt.append(bu.$el)}bu._initUI();return bu},repaint:function(bt){var bu=this;bu.$el.html(bu.template({nodeModel:bu.model,node:bu.model.toJSON(),reportView:bu.reportView,_commentOptions:W}));bu._initUI();bu.showNote(bt[bu.noteKey])},_initUI:function(){var bt=this;bt.$toolbarCnt=bt.$(".node-toolbar-cnt");bt.$toolbar=bt.$(".node-toolbar-box");bt.$note=bt.$(".note")},_isNoEvent:function(bt){if(this.$toolbarCnt.find(bt).length>0){return true}return false},_onMousedown:function(bt){aQ(this.$el,false)},_onClick:function(bt){if(this._isNoEvent(bt.target)){return}this.trigger("onClick",this,bt)},_onDblClick:function(bt){if(this._isNoEvent(bt.target)){return}this._onProperties()},_onMouseEnter:function(){var bt=this;bt.$el.addClass("hover");bt.$toolbar.show()},_onMouseLeave:function(){var bt=this;bt.$el.removeClass("hover");bt.$toolbar.hide()},_onAddRelatedNodes:function(){M.open(this.model)},_onDelete:function(){aw.open(this.model)},_onProperties:function(){aS.open(this.model)},_onComment:function(){var bv=this;var bx=bv.$el.offset();var bu=bv.$el.outerWidth();var bw=W.postId[bv.model.get("_type")];var bt=_.isFunction(bw)?bw(bv.model.toJSON()):bw;bk(bx.left+bu,bx.top,bt)},_onNote:function(){this.trigger("onNote",this)},_onToNewReport:function(){var bx=this;var bw=bx.model.get("_type");var bt=aY.getByName(bw);var bv=bt.get("idField");var bu=bx.model.get(bv);var by={"node.type":bw};by[bv+".equals"]=bu;ReportUtils.openNewReport(by)},setPosition:function(bu,bt){if(!bt){bu.left=Math.floor(bu.left/ReportSettings.drag.node.gridSize)*ReportSettings.drag.node.gridSize;bu.top=Math.floor(bu.top/ReportSettings.drag.node.gridSize)*ReportSettings.drag.node.gridSize}this.$el.css({"left":bu.left+"px","top":bu.top+"px"})},_select:function(bv,bt){var bw=this;if(bw.selected==bv){return}if(bv){bw.$el.addClass("selected");bw.selected=true}else{bw.$el.removeClass("selected");bw.selected=false}var bu=jsPlumb.getConnections({source:bw.id});_.each(bu,function(by){var bx=B(by);if(bv){bx.addClass("node-selected")}else{bx.removeClass("node-selected")}bw.reportView._setConnectionPaintStyle(by)});if(!bt){bw.trigger("onSelectChange",bw,bv)}},isSelected:function(){return this.selected},showNote:function(bt){if(bt){this.$note.html(ReportUtils.formatContent(bt)).show()}else{this.$note.html(bt).hide()}},setTheme:function(bv){var bu=this;bu.theme=bv;var bt=aG(bv);bu.$el.removeClass(ObjectTheme.objectViewClasses).addClass(bt.objectViewClass)}});var am=Backbone.View.extend({model:aq,el:K.filter("#node-properties-view-template").html(),propertyListTemplate:_.template(K.filter("#node-property-list-template").html()),companyReportTemplate:_.template(K.filter("#company-report-template").html()),initialize:function(){var bt=this;bt.$propertyList=bt.$(".node-property-list");bt.$toolbars=bt.$(".node-toolbar");bt.$companyEgrulBox=bt.$(".egrul-box.company");bt.companyEgrulListView=new Z();bt.companyEgrulListView.$el.appendTo(bt.$companyEgrulBox);bt.$companyReportBox=bt.$(".report-box.company");bt.$individualEgrulBox=bt.$(".egrul-box.individual");bt.egrulFounderIndividualsView=new z();bt.egrulFounderIndividualsView.$el.appendTo(bt.$individualEgrulBox);bt.egrulExecutiveIndividualsView=new ak();bt.egrulExecutiveIndividualsView.$el.appendTo(bt.$individualEgrulBox)},render:function(){var bu=this;var bt=bu.model.toJSON();bu.$toolbars.hide();bu.$propertyList.html(bu.propertyListTemplate({node:bt,nodeModel:bu.model}));if(bu.model.get("_type")=="COMPANY"){bu.companyEgrulListView.render(bu.model);bu.$companyReportBox.html(bu.companyReportTemplate({node:bt}))}else{if(bu.model.get("_type")=="INDIVIDUAL"){if(ReportUtils.isNoEgrulOrder(bu.model)){return bu}bu.egrulFounderIndividualsView.render(bu.model);bu.egrulExecutiveIndividualsView.render(bu.model)}}bu.$(".node-toolbar."+bu.model.get("_type").toLowerCase()).show();return bu}});var be=Backbone.View.extend({instances:[],orders:{},dataSource:null,productCode:null,permissions:[],initialize:function(bt){var bu=this;bu.instances.push(bu);br.on("reportChange",bu._onReportChange,bu)},events:{"click .order":"_doOrder"},render:function(bu){var bt=this;if(!bu){return bt}bt.nodeModel=bu;bt.nodeUID=bt.nodeModel.uid;bt._setState({process:bt._isOrderProcess(),disabled:!bt._isOrderAvailable()});bt.$el.html(bt.template({node:bu.toJSON()}));return bt},_onReportChange:function(bu,bv){var bt=this;if(bu==a8.update&&bv.holderNodeModel){bt._orderComplete(bv.holderNodeModel)}},_setState:function(bv){var bu=this;var bw="",bt="";_.each(bv,function(by,bx){if(by===true){bw+=" "+bx}else{if(by===false){bt+=" "+bx}}});_.each(bu.instances,function(bx){if(bu.nodeUID==bx.nodeUID){bx.$el.removeClass(bt).addClass(bw)}})},_isDisabled:function(){return this.$el.hasClass("disabled")},_doOrder:function(bu){var bt=this;bu.preventDefault();if(bt._isDisabled()){return}if(!br.checkPermissions(bt.permissions)){return}T.showWait();aW({method:"POST",url:ReportSettings.apiUrl+"/product/"+bt.productCode+"/purchase",data:bt._getRequestData(),success:function(){T.hide();bt._orderRequestComplete()}})},_getRequestData:function(){var bt=this;return{"name":bt.nodeModel.get("name")}},_isOrderProcess:function(){var bt=this;if(bt.orders[bt.nodeModel.uid]){return true}return false},_isOrderAvailable:function(){var bv=this;if(bv._isOrderProcess()){return false}var bt=bv.getLastOrderTime();if(bt){var bw=new Date(),bu=new Date(bt);if(bw.getFullYear()===bu.getFullYear()&&bw.getMonth()===bu.getMonth()&&bw.getDate()===bu.getDate()){return false}}return true},_orderRequestComplete:function(){var bt=this;bt.orders[bt.nodeModel.uid]=true;bt._setState({disabled:true,process:true});br.notification(new bt.NotificationView({holderNodeModel:bt.nodeModel}))},_orderComplete:function(bv){var bu=this;bu.orders[bv.uid]=false;var bt=br.getNodeInfo(bv.uid);if(bt){bv=bt.view.model;_.each(bu.instances,function(bw){if(bv.uid==bw.nodeUID){bw.render(bv)}})}},getLastOrderTime:function(){var bt=this;if(bt.nodeModel.get("_info")){return bt.nodeModel.get("_info").updates[bt.dataSource]}return null}});var bb=be.extend({instances:[],orders:{},permissions:["REQUEST_EGRUL"],dataSource:"egrul",productCode:"egrulCompanyReport",initialize:function(bt){be.prototype.initialize.call(this,bt);this.NotificationView=O},_getRequestData:function(){var bt=this;return{"companyName":bt.nodeModel.get("namesort"),"ogrn":bt.nodeModel.get("ogrn")}}});var Z=bb.extend({tagName:"div",className:"egrul-view egrul-list-view",template:_.template(K.filter("#egrul-list-view-template").html()),egrulListTemplate:_.template(K.filter("#egrul-list-template").html()),EgrulListModel:Backbone.Model.extend({url:ReportSettings["egrul.list.url"],fetch:function(bw,bt){var bv=this;bv.clear();var bu=_.extend({},{type:"POST",data:{"json":JSON.stringify({"inn":bw.get("inn"),"ogrn":bw.get("ogrn")})},success:function(){var bx=bv.toJSON();_.each(bx,function(bz,by){bz["fileId"]=by});bv.egrulList=_.sortBy(_.toArray(bx),function(by){return -(by.fileDate)});if(_.isFunction(bt.success)){bt.success.call(bv,bv.egrulList)}}});return Backbone.Model.prototype.fetch.call(this,bu)}}),initialize:function(bt){bb.prototype.initialize.call(this,bt);var bu=this;bu.egrulListModel=new bu.EgrulListModel()},render:function(bu){bb.prototype.render.call(this,bu);var bt=this;if(!bu){return bt}bt.$egrulList=bt.$(".egrul-list");bt.egrulListModel.fetch(bt.nodeModel,{success:function(bv){bt.$egrulList.slideUp(ReportSettings.effects.duration,function(){bt.$egrulList.html(bt.egrulListTemplate({egrulList:bv}));bt.$egrulList.slideDown(ReportSettings.effects.duration)})}});return bt}});var m=bb.extend({tagName:"div",className:"egrul-view egrul-info-view",template:_.template(K.filter("#egrul-info-view-template").html())});var z=be.extend({tagName:"div",className:"egrul-individuals-view egrul-founder-individuals-view",template:_.template(K.filter("#egrul-founder-individuals-view-template").html()),instances:[],orders:{},permissions:["REQUEST_EGRUL"],dataSource:"egrul_individual_founder",productCode:"egrulFounderPersonReport",initialize:function(bt){be.prototype.initialize.call(this,bt);this.NotificationView=ac}});var ak=be.extend({tagName:"div",className:"egrul-individuals-view egrul-executive-individuals-view",template:_.template(K.filter("#egrul-executive-individuals-view-template").html()),instances:[],orders:{},permissions:["REQUEST_EGRUL"],dataSource:"egrul_individual_executive",productCode:"egrulChiefReport",initialize:function(bt){be.prototype.initialize.call(this,bt);this.NotificationView=q}});var az=aM.extend({viewClassName:bq.LinkNodeGraphView,model:s,tagName:"div",className:aj,template:_.template(K.filter("#link-node-graph-view-template").html()),initialize:function(bt){var bu=this;bu.reportView=bt.reportView;bu.model=bt.model;bu.id=bu.model.viewId;bu.$el.html(bu.template({})).attr("id",bu.id).addClass(bu.model.get("_type").toLowerCase());bu.$header=bu.$(".node-header");bu.$toolbarCnt=bu.$(".node-toolbar-cnt");bu.$toolbar=bu.$(".node-toolbar-box")},events:function(){return _.extend({},aM.prototype.events,{"click .node-action-edit":"_onEdit","click .node-action-delete":"_onDelete"})},render:function(){var bt=this;bt.$header.html(ReportUtils.formatContent(bt.model.get("comment")));return bt},_onEdit:function(){this.trigger("onEdit",this.model)},_onDelete:function(){this.trigger("onDelete",this.model)}});var D=Backbone.View.extend({viewClassName:bq.RelationLabelView,tagName:"div",className:"relation-label-view",template:_.template(K.filter("#relation-label-view-template").html()),initialize:function(bt){var bu=this;bu.relationInfoList=[];bu.srcNodeView=bt.srcNodeView;bu.dstNodeView=bt.dstNodeView;bu.isContent=false;bu.state={}},events:{"click":"_onClick","click .relation-action-note":"_onNote","click .relation-action-expand":"_toogleExpand"},render:function(){var bt=this;bt.$el.removeClass("expanded").html(bt.template({relationInfoList:bt.relationInfoList,isContent:bt.isContent}));if(bt.$(".expand-only .entry").length<1){bt.$el.addClass("no-expand")}bt.$toolbarCnt=bt.$(".relation-toolbar-cnt");bt.$body=bt.$(".relation-body");bt.$note=bt.$(".note");var bu=bt.$el.parent();bt.$el.css({"left":-(bt.$el.outerWidth()/2)+bu.outerWidth()/2+"px","top":-(bt.$el.outerHeight()/2)+bu.outerHeight()/2+"px"});bt.setState({expanded:true});return bt},_onClick:function(bt){if(this.$toolbarCnt.find(bt.target).length>0){return false}},_onNote:function(){this.trigger("onNote",this)},_select:function(bu,bt){if(this.selected==bu){return}if(bu){this.$el.parent().addClass("selected");this.selected=true}else{this.$el.parent().removeClass("selected");this.selected=false}if(!bt){this.trigger("onSelectChange",this,bu)}},_toogleExpand:function(){var bu=this;bu.$el.toggleClass("expanded");var bt=bu.$el.hasClass("expanded");bu._checkEmtyCollapse(bt);_.extend(bu.state,{expanded:bt})},_checkEmtyCollapse:function(bt){var bu=this;if(!bt&&bu.$body.hasClass("with-content")&&bu.$body.find(":visible").length<1){bu.$el.addClass("emty-collapse")}else{bu.$el.removeClass("emty-collapse")}},_checkContent:function(bt){if(bt.relationTypeMeta.connectionTitle||bt.relation._source||bt.relation._actual||bt.relation._since){return true}return false},isSelected:function(){return this.selected},addRelation:function(bu){var bt=this;bt.relationInfoList.push({relationTypeMeta:MetaUtils.getRelationType(bu._type),relation:bu});var bv=false;bt.relationInfoList=_.sortBy(bt.relationInfoList,function(bw){if(bt._checkContent(bw)){bv=true}return bw.relationTypeMeta.order});bt.isContent=bv},removeRelation:function(bu){var bt=this;var bv=false;_.each(bt.relationInfoList,function(bx,bw){if(ba(bu,bx.relation)){delete bt.relationInfoList[bw]}else{if(bt._checkContent(bx)){bv=true}}});bt.relationInfoList=_.compact(bt.relationInfoList);bt.isContent=bv},getRelationCount:function(){return this.relationInfoList.length},setState:function(bu){var bt=this;bt.state=bu||{};if(bt.state.expanded){bt.$el.addClass("expanded")}else{bt.$el.removeClass("expanded")}bt._checkEmtyCollapse(bt.state.expanded);if(_.isNumber(bt.state.location)){bt.setLabelLocation(bt.state.location)}},getState:function(){return this.state},setLabelLocation:function(bt){var bu=this;bt=(bt<0?0:(bt>1?1:bt));bu.connection.getOverlay("label").setLocation(bt);bu.state.location=bt},getLabelLocation:function(){return this.connection.getOverlay("label").getLocation()},showNote:function(bt){this.note=bt;if(bt){this.$note.html(ReportUtils.formatContent(bt)).show()}else{this.$note.text("").hide()}}});var Y=Backbone.View.extend({el:K.filter("#toolbar-view-template").html(),toolbarWidthExtra:130,objectSelectedTools:["add-related-nodes","show-properties","search-relation","show-delete","objects-tools","link-nodes","relation-connection"],initialize:function(bt){var bu=this;bu.$toolbarTop=bu.$(".toolbar-top-view");bu.reportView=bt.reportView;bu.reportView.on("onReady",bu._onReportReady,bu);bu.reportView.on("onViewsSelectChange",bu._onViewsSelectChange,bu);bu.reportView.on("onHistoryChange",bu._onHistoryChange,bu);bu.newReportLink=bu.$(".new-report");bu.openReportLink=bu.$(".open-report");bu.saveReportLink=bu.$(".save-report");bu.saveAsReportLink=bu.$(".save-as-report");bu.deleteReportLink=bu.$(".delete-report");bu.exportReportLink=bu.$(".export-report");bu.addNodeBtn=bu.$(".add-node");bu.addRelatedNodesBtn=bu.$(".add-related-nodes");bu.showPropertiesBtn=bu.$(".show-properties");bu.showDeleteBtn=bu.$(".show-delete");bu.linkNodesBtn=bu.$(".link-nodes");bu.showSearchRelationBtn=bu.$(".search-relation")},events:{"click .object-theme-label":"_onObjectThemeSelect","click .line-style-label":"_onLineStyleSelect","click .undo":"_undo","click .redo":"_redo"},_onReportReady:function(){var bt=this;bt.enabledTools(["new-report","open-report","save-report","save-as-report","add-node","report-note"],true);bt._bindTool(bt.newReportLink,$.proxy(bt._onNewReport,bt));bt._bindToolToWidget(bt.openReportLink,a5,false);bt._bindTool(bt.saveReportLink,$.proxy(bt._onSaveReport,bt));bt._bindTool(bt.saveAsReportLink,$.proxy(bt._onSaveAsReport,bt));bt._bindToolToWidget(bt.deleteReportLink,a1,false);bt._bindToolToWidget(bt.exportReportLink,bs,false);bt._bindToolToWidget(bt.addNodeBtn,aL,true);bt._bindToolToWidget(bt.addRelatedNodesBtn,M,true);bt._bindToolToWidget(bt.showPropertiesBtn,aS,true);bt._bindToolToWidget(bt.showDeleteBtn,aw,true);bt._bindToolToWidget(bt.linkNodesBtn,a6,true);bt._bindToolToWidget(bt.showSearchRelationBtn,aV,true)},_bindTool:function(bt,bu){bt.click(function(bv){bv.preventDefault();if(bt.hasClass("disabled")){return}bu()})},_bindToolToWidget:function(bt,bu,bv){if(bv){bu.on("onOpen",function(){bt.addClass("active")});bu.on("onClose",function(){bt.removeClass("active")})}bt.click(function(bw){bw.preventDefault();if(bt.hasClass("disabled")){return}if(bv){if(bu.isOpen()){bu.close()}else{bu.open()}}else{bu.open()}}).bind("onToolEnableChange",function(bx,bw){if(!bw){bu.close()}})},_onViewsSelectChange:function(bt,bw){var bu=_.countBy(bt,function(bx){return bx.model.className});var bv=(bt.length==bu[aD.NodeModel]);this.enabledTools(["add-related-nodes","show-properties"],bv&&bt.length==1);this.enabledTools(["search-relation"],bv&&bt.length==2);this.enabledTools(["show-delete"],bu[aD.NodeModel]>0);this.enabledTools(["objects-tools"],(bv&&bt.length>0)||bw.length>0);this.enabledTools(["link-nodes"],bv&&bt.length>1);this.enabledTools(["relation-connection"],bw.length>0)},_onNewReport:function(){this.trigger("onNewReport")},_onSaveReport:function(){this.trigger("onSaveReport")},_onSaveAsReport:function(){this.trigger("onSaveAsReport")},_onObjectThemeSelect:function(bu){var bt=$(bu.currentTarget).attr("object-theme");this.reportView.selectObjectTheme(bt)},_onLineStyleSelect:function(bu){var bt=$(bu.currentTarget).attr("line-style");this.reportView.selectLineStyle(bt)},_initToolbarSize:function(){var bv=this;bv.$expandNav=bv.$toolbarTop.find(".nav-expand").hide();bv.$collapsedNav=bv.$toolbarTop.find(".nav.collapsed");bv.$navParent=bv.$toolbarTop.find(".nav-parent");bv.navElementsInfoList=[];var bu=0;var bt=bv.$collapsedNav.filter(".pull-right").removeClass("pull-right");bv.$collapsedNav.children().each(function(){var bw=$(this);var bx=bw.offset().left+bw.outerWidth();bu=(bx>bu?bx:bu);bv.navElementsInfoList.push({$el:bw,$parent:bw.parent(),right:bu})});bt.addClass("pull-right");bv.$navParent.css("min-width",bu+bv.toolbarWidthExtra/2+"px");ah.resize(function(){bv._checkToolbarSize()});bv.$expandBtn=bv.$toolbarTop.find(".action-nav-expand").hide().click(function(){bv.$el.toggleClass("expanded");if(bv.$el.hasClass("expanded")){bv.$expandNav.show()}else{bv.$expandNav.hide()}})},_checkToolbarSize:function(){var bu=this;var bt=ah.innerWidth();_.each(bu.navElementsInfoList,function(bv){if(bt-bv.right<bu.toolbarWidthExtra){bu.$expandNav.append(bv.$el)}else{bv.$parent.append(bv.$el)}});if(bu.$expandNav.children().length>0){bu.$expandBtn.show();bu.$toolbarTop.addClass("collapsed")}else{bu.$expandBtn.hide();bu.$toolbarTop.removeClass("collapsed")}},_onHistoryChange:function(bt){var bu=this;bu.enabledTools(["undo"],bt.canUndo);bu.enabledTools(["redo"],bt.canRedo)},_undo:function(){this.reportView.undo()},_redo:function(){this.reportView.redo()},_getTools:function(bt){return this.$("."+bt.join(", ."))},enabledTools:function(bv,bt){var bu=this._getTools(bv);bu.each(function(){var bw=$(this);if(!bw.hasClass("strong-disabled")){if(bt){bw.removeClass("disabled").prop("disabled",false)}else{bw.addClass("disabled").prop("disabled",true)}bw.trigger("onToolEnableChange",[bt])}})},addToolsClass:function(bu,bt){this._getTools(bu).addClass(bt)},removeToolsClass:function(bu,bt){this._getTools(bu).removeClass(bt)},strongDisabledTools:function(bu){var bt=this._getTools(bu);bt.addClass("strong-disabled disabled").prop("disabled",true);bt.trigger("onToolEnableChange",[false])}});var bp=Backbone.View.extend({el:K.filter("#report-area-view-template").html(),initialize:function(){at(this.$el);this.$el.on("mousedown","."+aj+", ."+aI,function(){at($(this))})},getAreaEl:function(){return this.$el}});var ay=Backbone.View.extend({el:K.filter("#node-drag-helper-view-template").html(),removeFromNodeViewSelector:".node-toolbar-cnt, .ie-shadow-fix",initialize:function(bt){var bu=this;bu.reportView=bt.reportView;bu.dragParentEl=bt.dragParentEl;bu.$parent=ae;bu.dragNodesCnt=bu.$(".drag-nodes-cnt");bu.nodeDragViews=[]},_initDragView:function(bx){var bw=this;var bt=bx.$el.data("draggable");bw.nodeDragViews=[bx];_.each(bw.reportView.selectedNodeViews,function(by){if(by.id!==bx.id){bw.nodeDragViews.push(by)}});bw.dragNodesCnt.empty();var bu=bx.$el.offset();var bv={left:Number.MAX_VALUE,top:Number.MAX_VALUE,right:-Number.MAX_VALUE,bottom:-Number.MAX_VALUE};_.each(bw.nodeDragViews,function(bz){var bB=bz.$el.offset();var bA=bz.$el.outerWidth();var by=bz.$el.outerHeight();bv.left=(bv.left>bB.left?bB.left:bv.left);bv.top=(bv.top>bB.top?bB.top:bv.top);bv.right=(bv.right<bB.left+bA?bB.left+bA:bv.right);bv.bottom=(bv.bottom<bB.top+by?bB.top+by:bv.bottom)});_.each(bw.nodeDragViews,function(by){var bA=by.$el.offset();var bz=by.$el.clone(false,false).css({"left":bA.left-bv.left+"px","top":bA.top-bv.top+"px"});bz.find(bw.removeFromNodeViewSelector).remove();bz.appendTo(bw.dragNodesCnt)});bw.dragNodesCnt.css({"left":bv.left-bu.left+"px","top":bv.top-bu.top+"px","width":bv.right-bv.left+"px","height":bv.bottom-bv.top+"px"});bt.containment=[d[0]-(bv.left-bu.left),d[1]-(bv.top-bu.top),d[2]-(bv.right-bu.left),d[3]-(bv.bottom-bu.top)]},initDrag:function(bu){var bt=this;bu.$el.draggable({appendTo:bt.$parent,grid:[ReportSettings.drag.node.gridSize,ReportSettings.drag.node.gridSize],helper:function(){return bt.$el},start:function(bv,bw){bt.start(bu,bv,bw)},drag:function(bv,bw){bt.drag(bu,bv,bw)},stop:function(bv,bw){bt.stop(bu,bv,bw)}})},start:function(bx,bu,bv){var bt=this;bt.reportView._doSelect(bx,bu);p();bt._initDragView(bx);var bw=bt.dragParentEl;bx.$el.data("draggable-extra",{prevClient:{x:bu.clientX,y:bu.clientY},prevParentPos:bw.offset()});bt.$el.show()},drag:function(bx,bt,bC){var bB=this;var bD=bx.$el;var bI=bD.data("draggable");var bE=bD.data("draggable-extra");var bw=bB.dragParentEl;var bA=bw.offset();var bH=bt.clientX-bE.prevClient.x;var bv=bA.left-bH;var by=(bC.offset.left<=bI.containment[0]+(ReportSettings.drag.node.gridSize-1)?(bv>=0?bv:bA.left):bE.prevParentPos.left);var bF=bt.clientY-bE.prevClient.y;var bu=bA.top-bF;var bz=(bC.offset.top<=bI.containment[1]+(ReportSettings.drag.node.gridSize-1)?(bu>=0?bu:bA.top):bE.prevParentPos.top);var bG={};if(by!==bA.left){bG.left=by}if(bz!==bA.top){bG.top=bz}bw.css(bG);bE.prevClient={x:bt.clientX,y:bt.clientY}},stop:function(bw,bt,bz){var by=this;var bA=bw.$el;var bv=by.dragParentEl;var bx=bv.offset();var bB=bA.offset();var bu={left:bz.offset.left-bx.left,top:bz.offset.top-bx.top};bw.setPosition({left:bu.left,top:bu.top});jsPlumb.repaint(bw.$el);_.each(by.nodeDragViews,function(bC){if(bC.id!==bw.id){var bD=bC.$el.offset();bC.setPosition({left:bD.left+(bu.left-bB.left),top:bD.top+(bu.top-bB.top)});jsPlumb.repaint(bC.$el)}});by.$el.hide();by.reportView._reportChange(a8.drag)}});var Q=Backbone.View.extend({el:K.filter("#report-sketch-map-view-template").html(),viewWidth:screen.availWidth?Math.floor(screen.availWidth/5):400,viewHeight:screen.availHeight?Math.floor(screen.availHeight/5):300,maxRatio:0.1,initialize:function(bt){var bu=this;bu.reportView=bt.reportView;bu.reportView.on("initReport",bu._onInitReport,bu);bu.reportView.on("reportChange",bu._onReportChange,bu);bu.reportView.on("onHistory",bu._onReportHistory,bu);bu.$el.css({width:bu.viewWidth+"px",height:bu.viewHeight+"px"});bu.$sketch=bu.$(".sketch").css({width:bu.viewWidth+"px",height:bu.viewHeight+"px"});bu.$map=bu.$(".map");bu.$frameBox=bu.$(".frame-box");bu.$frame=bu.$(".frame");bu.$maskLeft=bu.$(".mask.left");bu.$maskRight=bu.$(".mask.right");bu.$maskTop=bu.$(".mask.top");bu.$maskBottom=bu.$(".mask.bottom");ah.resize(function(){bu._windowResize()}).scroll(function(){bu._windowResize()});bu.$frameBox.draggable({drag:function(bv,bw){bu._frameDrag(bv,bw)},stop:function(bv,bw){bu._frameDragStop(bv,bw)}})},_onInitReport:function(){this.update()},_onReportChange:function(bu){var bt=this;if(_.contains(aK,bu)){bt.update();if(_.contains(ax,bu)&&bt._isGraphLargeWindow()){bt.trigger("graphLargeWindow",bu)}}},_onReportHistory:function(){this.update()},_windowResize:function(){this._updateFrame()},_windowScroll:function(){this._updateFrame()},_toogleCollapse:function(){var bt=this;bt.$el.toggleClass("collapsed")},_isGraphLargeWindow:function(){var bt=this;return bt.graphInfo.right>ah.outerWidth()||bt.graphInfo.bottom>ah.outerHeight()},_getGraphInfo:function(){var bu=this;var bv={left:Number.MAX_VALUE,top:Number.MAX_VALUE,right:-Number.MAX_VALUE,bottom:-Number.MAX_VALUE,objects:[]};_.each(bu.reportView.nodeInfoMap,function(bw){bt(bw.view.$el)});_.each(bu.reportView.nodeLinkMap,function(bw){bt(bw.view.$el)});function bt(by){var bA=by.offset();var bz=by.outerWidth();var bx=by.outerHeight();var bw=bA.left+bz;var bB=bA.top+bx;if(bv.left>bA.left){bv.left=bA.left}if(bv.top>bA.top){bv.top=bA.top}if(bv.right<bw){bv.right=bw}if(bv.bottom<bB){bv.bottom=bB}bv.objects.push({left:bA.left,top:bA.top,width:bz,height:bx,classes:"object "+by.attr("class")})}return bv},_frameDrag:function(bt,bu){this._updateMask(bu.position.left,bu.position.top)},_frameDragStop:function(bu,bD){var bC=this;var bA=x();var bw=ah.outerWidth();var bt=ah.outerHeight();var bx=ah.scrollLeft();var bB=ah.scrollTop();var bG=Math.ceil(bD.position.left/bC.ratio);var bE=Math.ceil(bD.position.top/bC.ratio);var by=bC.scrollLeft+bG;var bv=bC.scrollTop+bE;var bz=bC.graphWidth;var bF=bC.graphHeight;if(bG==0||(by<0&&bC.scrollLeft<=0)||(by+bw>bA.clientWidth&&bx+bw>=bA.clientWidth)){by=null}if(bE==0||(bv<0&&bC.scrollTop<=0)||(bv+bt>bA.clientHeight&&bB+bt>=bA.clientHeight)){bv=null}if(by==null&&bv==null){bC._updateFrame()}else{window.scrollTo(by!=null?by:bC.scrollLeft,bv!=null?bv:bC.scrollTop)}},_updateMask:function(bv,bu){var bz=this;var bA=bz.$frame.position();var by=bA.left+bv;var bx=bA.top+bu;var bt=bz.$frame.outerWidth();var bw=bz.$frame.outerHeight();bz.$maskLeft.css({width:(by>0?by:0)+"px"});bz.$maskRight.css({left:(by+bt)+"px"});bz.$maskTop.css({left:by+"px",width:bt+"px",height:(bx>0?bx:0)+"px"});bz.$maskBottom.css({left:by+"px",width:bt+"px",top:(bx+bw)+"px"})},_updateFrame:function(){var bt=this;if(!bt.isUpdated){return}bt.windowWidth=ah.outerWidth();bt.windowHeight=ah.outerHeight();bt.scrollLeft=ah.scrollLeft();bt.scrollTop=ah.scrollTop();bt.$frameBox.css({left:"0",top:"0"});bt.$frame.css({left:Math.floor(bt.scrollLeft*bt.ratio)-1+"px",top:Math.floor(bt.scrollTop*bt.ratio)-1+"px",width:Math.floor(bt.windowWidth*bt.ratio)+2+"px",height:Math.floor(bt.windowHeight*bt.ratio)+2+"px"});bt._updateMask(0,0)},update:function(){var bw=this;bw.$map.empty();bw.graphInfo=bw._getGraphInfo();if(!_.size(bw.graphInfo.objects)){bw.$sketch.hide();bw.trigger("graphEmpty");return}var bt=x();bw.graphWidth=bt.clientWidth;bw.graphHeight=bt.clientHeight;var bv=bw.viewWidth/bw.graphWidth;var bu=bw.viewHeight/bw.graphHeight;bw.ratio=Math.min(bv,bu);bw.ratio=Math.min(bw.ratio,bw.maxRatio);_.each(bw.graphInfo.objects,function(bx){var by=$("<div>",{css:{left:Math.floor(bx.left*bw.ratio)+"px",top:Math.floor(bx.top*bw.ratio)+"px",width:Math.floor(bx.width*bw.ratio)+"px",height:Math.floor(bx.height*bw.ratio)+"px"},"class":bx.classes}).appendTo(bw.$map)});bw.isUpdated=true;bw._updateFrame();bw.$sketch.show()}});var g=Backbone.View.extend({el:K.filter("#report-select-area-view-template").html(),initialize:function(bt){var bu=this;bu.reportView=bt.reportView;bu.$laying=bu.$(".laying").appendTo(ae).hide();bu.select=false;N.mousedown(function(bw){var bv=$(bw.target);if(bw.which===1&&!bu.select&&(bv.is(ae)||bv.is(".body-background")||bv.is(".left-top-corner")||bv.is("#report-area svg")||bv.is("#report-area vml")||bv.is("#report-area canvas")||bv.is("#report-area"))){bu.select=true;bv.click();bu.pageX=bw.pageX;bu.pageY=bw.pageY;bu.$el.css({left:bu.pageX+"px",top:bu.pageY+"px",width:"0",height:"0"}).show();bu.$laying.show();bu.trigger("selectAreaStart",bw);return false}else{bu.select=false}}).mousemove(function(by){if(bu.select){var bw=by.pageX-bu.pageX;var bv=by.pageY-bu.pageY;var bx={left:(bw>=0?bu.pageX:by.pageX),top:(bv>=0?bu.pageY:by.pageY),width:Math.abs(bw),height:Math.abs(bv)};bu.$el.css({left:bx.left+"px",top:bx.top+"px",width:bx.width+"px",height:bx.height+"px"});bu.trigger("selectArea",bx,by)}}).mouseup(function(bv){bu.select=false;bu.$el.hide();bu.$laying.hide()}).bind("selectstart",function(bv){if(bu.select){return false}})}});var y=Backbone.View.extend({el:K.filter("#relation-label-drag-helper-view-template").html(),initialize:function(bt){var bu=this;bu.reportView=bt.reportView;bu.$laying=bu.$(".laying").appendTo(ae).hide();bu.dragView=null;N.mousemove(function(bB){if(bu.dragView){var bw=bu.endpointsOffset.dst.left-bu.endpointsOffset.src.left;var bv=bu.endpointsOffset.dst.top-bu.endpointsOffset.src.top;var bC=Math.sqrt(bw*bw+bv*bv);if(bC>1){var bA=bB.pageX-bu.pageX;var bz=bB.pageY-bu.pageY;var bx=Math.sqrt(bA*bA+bz*bz);var bE=(bA*bw+bz*bv)/(bx*bC);var by=bx*bE/bC;var bD=bu.labelLocation+by;bD=(bD<0?0:(bD>1?1:bD));bu.dragView.setLabelLocation(bD)}}}).mouseup(function(bv){bu.dragView=null;bu.$laying.hide()}).bind("selectstart",function(bv){if(bu.dragView){return false}})},initDrag:function(bu){var bt=this;bu.$el.mousedown(function(by){var bw=$(by.target);if(by.which===1&&!bt.dragView&&!bw.is(".relation-toolbar-cnt, .relation-toolbar-cnt *")){bt.dragView=bu;bt.reportView._relationClick(bt.dragView,by);bt.pageX=by.pageX;bt.pageY=by.pageY;var bx=bt.dragView.connection.endpoints[0];var bv=bt.dragView.connection.endpoints[1];bt.endpointsOffset={src:$(bx.canvas).offset(),dst:$(bv.canvas).offset()};if(bx.elementId===bv.elementId){bt.endpointsOffset.dst=bt.endpointsOffset.src}bt.labelLocation=bt.dragView.getLabelLocation();bt.$laying.show();return false}else{bt.dragView=null}})}});var aC=Backbone.View.extend({initialize:function(bt){var bu=this},events:{"click":"_doRead","focus":"_doRead","focusin":"_doRead","click .remove":"_doRemove"},_doRead:function(){var bt=this;bt.$el.addClass("read");bt.trigger("read",bt)},_doRemove:function(){var bt=this;bt.trigger("remove",bt)}});var bm=aC.extend({tagName:"div",className:"report-notification-view simple-report-notification-view",template:_.template(K.filter("#simple-report-notification-view-template").html()),initialize:function(bt){aC.prototype.initialize.call(this,bt);var bu=this;bu.$el.html(bu.template({content:bt.content}))},events:function(){return _.extend({},aC.prototype.events,{})}});var i=aC.extend({initialize:function(bt){aC.prototype.initialize.call(this,bt);var bu=this;bu.holderNodeModel=bt.holderNodeModel;bu.$el.html(bu.template({holderNode:bu.holderNodeModel.toJSON()}))},events:function(){return _.extend({},aC.prototype.events,{"click .holder":"_doHolderActive"})},_doHolderActive:function(bv){bv.preventDefault();var bu=this;var bt=br.getNodeInfo(bu.holderNodeModel.uid);br.activateNodeView(bt.view)}});var O=i.extend({tagName:"div",className:"report-notification-view egrul-order-notification-view",template:_.template(K.filter("#egrul-order-notification-view-template").html())});var ac=i.extend({tagName:"div",className:"report-notification-view egrul-founder-individuals-order-notification-view",template:_.template(K.filter("#egrul-founder-individuals-order-notification-view-template").html())});var q=i.extend({tagName:"div",className:"report-notification-view egrul-executive-individuals-order-notification-view",template:_.template(K.filter("#egrul-executive-individuals-order-notification-view-template").html())});var X=aC.extend({initialize:function(bt){aC.prototype.initialize.call(this,bt);var bu=this;bu.holderNodeModel=bt.holderNodeModel;bu.type=bt.type;bu.$el.html(bu.template({holderNode:bu.holderNodeModel.toJSON(),type:bu.type}))},events:function(){return _.extend({},aC.prototype.events,{"click .holder":"_doHolderActive","click .add-related":"_doAddRelated"})},_doHolderActive:function(bv){bv.preventDefault();var bu=this;var bt=br.getNodeInfo(bu.holderNodeModel.uid);br.activateNodeView(bt.view)},_doAddRelated:function(bv){bv.preventDefault();var bu=this;var bt=br.getNodeInfo(bu.holderNodeModel.uid);br.activateNodeView(bt.view);M.open(bt.view.model)}});var a2=X.extend({tagName:"div",className:"report-notification-view egrul-report-update-notification-view",template:_.template(K.filter("#egrul-report-update-notification-view-template").html())});var ar=X.extend({tagName:"div",className:"report-notification-view egrul-founder-individuals-report-update-notification-view",template:_.template(K.filter("#egrul-founder-individuals-report-update-notification-view-template").html())});var P=X.extend({tagName:"div",className:"report-notification-view egrul-executive-individuals-report-update-notification-view",template:_.template(K.filter("#egrul-executive-individuals-report-update-notification-view-template").html())});var G=Backbone.View.extend({jScrollPaneOptions:{verticalGutter:2,horizontalGutter:2,autoReinitialise:false,maintainPosition:true,clickOnTrack:true,enableKeyboardNavigation:false,hideFocus:true},dropdownMinHeight:50,initialize:function(bt){var bu=this;bu.$el=$("#report-notification-widget");bu.$dropdownToggle=bu.$(".btn.dropdown-toggle").parent();bu.$dropdownIcon=bu.$(".btn.dropdown-toggle i");bu.$dropdown=bu.$(".dropdown-widget").click(function(bv){bv.stopPropagation()});bu.$noNotification=bu.$(".no-notification");bu.$notificationCnt=bu.$(".notification-cnt");bu.$notificationList=bu.$(".notification-list");bu.$scrollFadeTop=bu.$(".scroll-fade-top");bu.$scrollFadeBottom=bu.$(".scroll-fade-bottom");bu.$notificationCnt.jScrollPane(bu.jScrollPaneOptions).bind("jsp-scroll-y",function(bx,bw,by,bv){bu._checkScrollBorder(by,bv)});bu.jScrollPane=bu.$notificationCnt.data("jsp");bu.$notificationCnt.append(bu.$scrollFadeTop);bu.$notificationCnt.append(bu.$scrollFadeBottom);ah.resize(function(){bu._checkWidgetSize(true)})},events:{"click .btn.dropdown-toggle":"_onDropdownToggleClick"},_onDropdownToggleClick:function(bu){var bt=this;if(bt.isOpen()){bt.close()}else{bt.open()}return false},_setNoticed:function(bt){var bu=this;if(bt){bu.$el.addClass("new-notification");bu.$dropdownIcon.addClass("info");bu.$noNotification.hide();bu.$notificationCnt.show()}else{bu.$el.removeClass("new-notification");bu.$dropdownIcon.removeClass("info");if(bu.$notificationList.is(":empty")){bu.$noNotification.show();bu.$notificationCnt.hide()}}},_onNotificationRead:function(bt){this._checkUnread()},_onNotificationRemove:function(bt){var bu=this;bt.$el.fadeOut(ReportSettings.effects.duration,function(){bt.remove();bu._updateScroll();bu._checkUnread()})},_checkUnread:function(){var bt=this;if(bt.$notificationList.children(":not(.read)").length==0){bt._setNoticed(false)}},_checkScrollBorder:function(bt,bv){var bu=this;if(bt){bu.$notificationCnt.addClass("scrolled-top")}else{bu.$notificationCnt.removeClass("scrolled-top")}if(bv){bu.$notificationCnt.addClass("scrolled-bottom")}else{bu.$notificationCnt.removeClass("scrolled-bottom")}},_checkListSize:function(){var bt=this;bt.$notificationCnt.css({height:bt.$notificationList.outerHeight()+"px"});bt._checkWidgetSize()},_checkWidgetSize:function(bv){var bx=this;var bu=bx.$dropdown.offset();var by=ReportSettings.windowBounds.top;var bw=ah.scrollTop();if(bu.top<by+bw){var bt=bx._getListHeight()+bu.top-by-bw;bx.$notificationCnt.css({height:(bt>bx.dropdownMinHeight?bt:bx.dropdownMinHeight)+"px"});if(bv){bx._reinitScroll()}}},_reinitScroll:function(){var bu=this;if(bu.jScrollPaneOptions.maintainPosition){var bt=bu.jScrollPane.getContentHeight();bu.jScrollPane.reinitialise();bu.jScrollPane.scrollByY(bu.jScrollPane.getContentHeight()-bt,false)}else{var bv=bu.jScrollPane.getContentPositionY();var bt=bu.jScrollPane.getContentHeight();bu.jScrollPane.reinitialise();bu.jScrollPane.scrollToY(bv+bu.jScrollPane.getContentHeight()-bt,false)}},_getListHeight:function(){return parseInt(this.$notificationCnt.css("height"))},_updateScroll:function(){var bt=this;bt._checkListSize();bt._reinitScroll()},isOpen:function(){return this.$dropdownToggle.hasClass("open")},open:function(){var bt=this;bt.$dropdownToggle.addClass("open");bt._updateScroll()},close:function(){var bt=this;bt.$dropdownToggle.removeClass("open")},notification:function(bt){var bu=this;bt.on("read",bu._onNotificationRead,bu);bt.on("remove",bu._onNotificationRemove,bu);bu.$notificationList.prepend(bt.$el);bu._setNoticed(true);bu.open()}});var bo=Backbone.Model.extend({initialize:function(bt){var bu=this},_doUpdate:function(bt){this.trigger("update",bt)},pushState:function(bt){throw new Error("Unsupported operation")}});var aP=bo.extend({requestDefault:{url:ReportSettings.apiUrl+"/push/report/update",contentType:"application/json",transport:"long-polling",fallbackTransport:"long-polling"},initialize:function(bt){bo.prototype.initialize.call(this,bt);var bu=this;bu.reportView=bt.reportView;bu.requestDefault={url:ReportSettings.apiUrl+"/push/report/update",contentType:"application/json",transport:"long-polling",fallbackTransport:"long-polling",onMessage:$.proxy(bu._onMessage,bu)};bu.reportView.on("authenticate",bu._onAuthenticate,bu)},_onAuthenticate:function(){this._connect()},_isReady:function(){if(this.subSocket){return true}return false},_connect:function(){var bt=this;if(!bt.reportView._canPushStateByUser()){return}$.atmosphere.unsubscribe();bt.subSocket=$.atmosphere.subscribe(_.extend({},bt.requestDefault,{uuid:$.atmosphere.guid()}))},_onMessage:function(bt){var bu=this;var bv;try{bv=$.parseJSON(bt.responseBody)}catch(bw){Logger.log("AtmosphereReportUpdater: fail JSON: ",bt.responseBody);return}bu._doUpdate(bv)},pushState:function(bu){var bt=this;if(!bt.reportView._canPushStateByUser()){return}if(!bt._isReady()){return}bt.subSocket.push(JSON.stringify(bu))}});var f=Backbone.View.extend({el:bd,nodeViewsBounds:{left:ReportSettings.areaBounds.left,top:ReportSettings.areaBounds.top,right:ReportSettings.areaBounds.left,bottom:ReportSettings.areaBounds.top},nodeViewsSafetySpace:{left:0,top:0,right:100,bottom:100},nodeInfoMap:{},nodeLinkMap:{},reportModel:null,historySize:ReportSettings.historySize,initialize:function(){var bt=this;bt.nodeInfoMap={};bt.nodeLinkMap={};bt.reportModel=null;bt._resetSelect();bt._resetHistory();bt.toolbarView=new Y({reportView:bt});bt.reportAreaView=new bp();bt.nodeDragHelperView=new ay({reportView:bt,dragParentEl:bt.reportAreaView.getAreaEl()});bt.reportSketchMapView=new Q({reportView:bt});bt.reportSelectAreaView=new g({reportView:bt});bt.reportSelectAreaView.on("selectAreaStart",bt._onSelectAreaStart,bt);bt.reportSelectAreaView.on("selectArea",bt._onSelectArea,bt);bt.relationLabelDragHelperView=new y({reportView:bt});bt.$el.append(bt.toolbarView.$el);bt.$el.append(bt.reportAreaView.$el);bt.$el.append(bt.reportSketchMapView.$el);bt.$el.append(bt.reportSelectAreaView.$el);bt.toolbarView._initToolbarSize();bt.toolbarView._checkToolbarSize();bt.reportNotificationWidget=new G({reportView:bt});bt.reportUpdater=new aP({reportView:bt});bt.reportUpdater.on("update",bt._onReportUpdate,bt);bt._loadDataAll=2;bt._loadDataCount=0;T.showWait();aY.fetch({success:function(){bt._loadDataCount++;bt._checkLoadData()}});an.fetch({success:function(){bt._loadDataCount++;bt._checkLoadData()}});bt.$reportNoteWidget=bt.toolbarView.$(".report-note-widget").click(function(bu){bu.stopPropagation()});bt.$reportNoteText=bt.$reportNoteWidget.find("textarea");bt.$reportNoteWidget.find(".action-save").click(function(){bt._closeReportNoteWidget();bt._setReportNote(bt.$reportNoteText.val());bt._reportChange(a8.reportNote)});bt.$reportNoteWidget.find(".action-cencel").click(function(){bt._closeReportNoteWidget();bt._setReportNote(bt.reportModel.get("comment"))});bt.$reportShareWidget=bt.toolbarView.$(".report-share-widget").click(function(bu){bu.stopPropagation()});bt.$reportSharedCheckbox=bt.$reportShareWidget.find(".report-shared-checkbox").change(function(){bt._doShared(bt.$reportSharedCheckbox.is(":checked"))});bt.$reportShareUrl=bt.$reportShareWidget.find(".report-share-url").bind("focus click",function(){var bu=$(this);bu.select();bu.mouseup(function(){bu.unbind("mouseup");return false})});bt.toolbarView.$(".lang-choose a").click(function(){var bv=$(this).attr("data-lang");if(bt._isEmptyReport()){bu()}else{T.confirm(_i18n.Messages.report["unsaved"]+"<br>"+_i18n.Messages.report["save-prompt"]+"<br><br>"+_i18n.Messages.report["language.change"],"warning",{yes:bu})}function bu(){var bw=$.url(document.location.href).param();delete bw[""];bw["lang"]=bv;ah.unbind("beforeunload");ReportUtils.openUrl(ReportUtils.getPageBaseUrl()+"?"+$.param(bw))}return false});bt.$reportSketchMapWidget=bt.toolbarView.$(".report-sketch-map-widget").click(function(bu){bu.stopPropagation()}).append(bt.reportSketchMapView.$el);bt.$reportSketchMapTool=bt.toolbarView.$(".report-sketch-map").click(function(bu){bt.$reportSketchMapTool.parent().toggleClass("open");bt.reportSketchMapView._updateFrame()});bt.reportSketchMapView.on("graphLargeWindow",function(){bt.$reportSketchMapTool.parent().addClass("open");bt.reportSketchMapView._updateFrame()},bt);bt.reportSketchMapView.on("graphEmpty",function(){bt.$reportSketchMapTool.parent().removeClass("open")},bt);bt.$reportName=bt.toolbarView.$(".report-name")},_isShared:function(){return this.shared},markedShared:function(bu){var bt=this;bt.shared=bu;bt.$reportSharedCheckbox.prop("checked",bu);if(bu){bt.$reportShareWidget.addClass("shared");bt.toolbarView.addToolsClass(["report-share"],"success")}else{bt.$reportShareWidget.removeClass("shared");bt.toolbarView.removeToolsClass(["report-share"],"success")}},getReportId:function(){return this.reportModel.id},_doShared:function(bu){var bt=this;T.showWait();bt.reportModel.partialSave({shared:bu},{error:function(bv,bw){T.showMessage(ReportUtils.getServerErrorMessage(bw.responseText),"error")},success:function(){bt.markedShared(bu);a5.markedReportShared(bt.reportModel.id,bu);T.hide()}})},_checkLoadData:function(){if(this._loadDataCount==this._loadDataAll){this._onReady()}},_closeReportNoteWidget:function(){this.$reportNoteWidget.parent().removeClass("open")},_cascadeNodesPosition:function(){this.$reportNoteWidget.parent().removeClass("open")},_doAddNode:function(bw,bt){var bv=this;var bu=[];_.each(bw,function(bA){var by=bA.uid;var bx=bv.nodeInfoMap[by]?false:true;var bz=bv.addNode(bA,true);if(bx){bu.push(bz)}});bv._positionNodeViews(bu);_.each(bu,function(bx){bv._doAddRelationsExistingObject(bx.model)});if(!bt){bv._reportChange(a8.addNode)}return bu},_doAddRelatedNode:function(bw,bv,bt){var bu=this;_.each(bv,function(bx){bu.addRelatedNode(bw,bx.srcNodeModel,bx.dstNodeModel,bx.relationType,bx.relationTypeExt,null);bu._doAddRelationsExistingObject(bx.srcNodeModel.uid==bw.uid?bx.dstNodeModel:bx.srcNodeModel)});bu._checkGraphNodeViews();if(!bt){bu._reportChange(a8.addRelatedNode)}},_doAddRelationsExistingObject:function(bu){var bt=this;_.each(bu.get("_relations"),function(by){var bx=an.getByName(by["_type"]).toJSON();var bv=e(by["_srcId"],bx.sourceNodeType);var bw=e(by["_dstId"],bx.destinationNodeType);if(_.has(bt.nodeInfoMap,bv)&&_.has(bt.nodeInfoMap,bw)){var bA=bt.nodeInfoMap[bv].view.model;var bz=bt.nodeInfoMap[bw].view.model;bt.addRelatedNode(bu,bA,bz,bx,MetaUtils.getRelationTypeExtByBaseRelationType(bx.name),by,true)}})},_doDeleteNode:function(bv,bt){var bu=this;p();_.each(bv,function(by){var bx=by.uid;var bw=bu.nodeInfoMap[bx].view;bu._doSelect(bw,null,{select:false,unselect:true});_.each(bu.nodeInfoMap,function(bA,bz){_.each(bA.relations,function(bB,bC){_.each(bB,function(bD){if((bC==bx||bz==bx)&&bD.connection){bD.view.remove();jsPlumb.detach(bD.connection)}})});if(bA.relations){delete bA.relations[bx]}});delete bu.nodeInfoMap[bx];_.each(bu.nodeLinkMap,function(bA){var bz=bA.view.model;var bB=bA.nodeModelList;_.each(bB.slice(0),function(bC,bD){if(bC.uid==by.uid){bB.splice(bD,1)}});if(bB.length<=1){bu._doLinkNodesDelete(bz,true)}});jsPlumb.detachAllConnections(bw.$el);bw.remove()});bu.trigger("onDeleteNode",bv);if(!bt){bu._reportChange(a8.deleteNode)}},_checkGraphNodeViews:function(){var bt=this;var bw=Number.MAX_VALUE;var bv=Number.MAX_VALUE;_.each(bt.nodeInfoMap,function(bz){var bA=bz.view.$el.offset();if(bA.left<bw){bw=bA.left}if(bA.top<bv){bv=bA.top}});var bx=ReportSettings.areaBounds.left;var bu=ReportSettings.areaBounds.top;var by=this.getAreaPosition();bt.setAreaPosition({left:by.left+(bw<bx?(bx-bw):0),top:by.top+(bv<bu?(bu-bv):0)})},_checkNodeViewsBounds:function(){var bt=this;bt.nodeViewsBounds={left:ReportSettings.areaBounds.left,top:ReportSettings.areaBounds.top,right:ReportSettings.areaBounds.left,bottom:ReportSettings.areaBounds.top};$("."+aj+", ."+aI+", .pin-widget").each(function(bw,bx){var bv=$(bx);var by=bv.offset();var bu=by.left+bv.outerWidth();var bz=by.top+bv.outerHeight();if(bt.nodeViewsBounds.right<bu){bt.nodeViewsBounds.right=bu}if(bt.nodeViewsBounds.bottom<bz){bt.nodeViewsBounds.bottom=bz}})},_getNextNodeViewInfo:function(by,bF){var bC=this;var bv=bC.getAreaPosition();if(bF){var bG=bF.relationTypeExt;var bt=bG.connection;var bz=bF.nodeModel.uid;var bA=bF.toNodeModel.uid;var bE=bC.nodeInfoMap[bA].view;var bB=bC.nodeInfoMap[bz];var bD=bB.relations;var bx=bB.view.$el.offset();function bu(bI){var bH=bI.direct=="left"||bI.direct=="right";var bL=(bH?(bx.left+bI.offset):bx.left);var bK=(!bH?(bx.top+bI.offset):bx.top);var bJ={left:Number.MAX_VALUE,top:Number.MAX_VALUE,right:-Number.MAX_VALUE,bottom:-Number.MAX_VALUE};_.each(bD,function(bM,bN){_.each(bM,function(bP,bR){if((bP.relationTypeExt.connection.direct==bI.direct)&&bP.parents==bG.parents){var bQ=bC.nodeInfoMap[bN].view;if(bQ.id!=bE.id){var bT=bQ.$el.offset();var bS=bQ.$el.outerWidth();var bO=bQ.$el.outerHeight();if(bT.left<bJ.left){bJ.left=bT.left}if(bT.top<bJ.top){bJ.top=bT.top}if(bT.left+bS>bJ.right){bJ.right=bT.left+bS}if(bT.top+bO>bJ.bottom){bJ.bottom=bT.top+bO}}}})});if(bJ.left!=Number.MAX_VALUE){bL=(bH?bJ.left:bJ.right+10);bK=(!bH?bJ.top:bJ.bottom+10)}return{connection:bI,pos:{left:bL-bv.left,top:bK-bv.top}}}return bu(bt)}else{return bw()}function bw(){var bH=bC._getGraphArea([by]);return{connection:{},pos:{left:bH.right-bv.left,top:bH.bottom-bv.top}}}},_getGraphArea:function(by){var bz=this;var bw=ReportSettings.areaBounds.left;var bB=ReportSettings.areaBounds.left;var bA=ReportSettings.areaBounds.top;var bu=ReportSettings.areaBounds.top;var bt={left:Number.MAX_VALUE,top:Number.MAX_VALUE,right:-Number.MAX_VALUE,bottom:-Number.MAX_VALUE};_.each(bz.nodeInfoMap,function(bC){bv(bC.view)});_.each(bz.nodeLinkMap,function(bC){bv(bC.view)});if(bt.left!=Number.MAX_VALUE){bw=bt.left;bB=bt.right;bA=bt.top;bu=bt.bottom}function bv(bD){if(!bx(bD)){var bE=bD.$el;var bG=bE.offset();var bF=bE.outerWidth();var bC=bE.outerHeight();if(bG.left<bt.left){bt.left=bG.left}if(bG.top<bt.top){bt.top=bG.top}if(bG.left+bF>bt.right){bt.right=bG.left+bF}if(bG.top+bC>bt.bottom){bt.bottom=bG.top+bC}}}function bx(bC){var bC=_.find(by,function(bD){return bD.id===bC.id});return(bC?true:false)}return{left:bw,right:bB,top:bA,bottom:bu}},_positionNodeViews:function(bz){var bA=this;var bv=bA.getAreaPosition();var bx=bA._getGraphArea(bz);var bu=ah.outerWidth();var by={left:(bx.left>ReportSettings.areaBounds.left?bx.left+ReportSettings.graphObjectSpacing:bx.left),top:(bx.bottom>ReportSettings.areaBounds.top?bx.bottom+ReportSettings.graphObjectSpacing:bx.bottom)};var bB={left:by.left,top:by.top};var bw=0;var bt=0;_.each(bz,function(bG){bG.setPosition({left:bB.left-bv.left,top:bB.top-bv.top});var bD=bG.$el;var bF=bD.outerWidth();var bC=bD.outerHeight();var bE=bF+ReportSettings.graphObjectSpacing;bw+=bE;bt=(bt<bC?bC:bt);if(bw>bu-bE){bB.left=by.left;bB.top+=(bt+ReportSettings.graphObjectSpacing);bw=0;bt=0}else{bB.left=bB.left+bE}})},_positionNodeViewOfWindowCenter:function(by){var bz=this;var bw=bz.getAreaPosition();var bv=ah.outerWidth();var bt=ah.outerHeight();var bu=by.$el.outerWidth();var bB=by.$el.outerHeight();var bx=(bv-bu)/2;var bA=(bt-bB)/2;by.setPosition({left:bx-bw.left,top:(bA<ReportSettings.areaBounds.top?ReportSettings.areaBounds.top:bA)-bw.top})},_initNodeDrag:function(bt){this.nodeDragHelperView.initDrag(bt)},_onNodeNote:function(bt){al.editNote("NODE",{nodeModel:bt.model,objectInfo:this.nodeInfoMap[bt.model.uid]})},_onRelationNote:function(bv){var bu=bv.srcNodeView.model;var bt=bv.dstNodeView.model;al.editNote("RELATION",{srcNodeModel:bu,dstNodeModel:bt,objectInfo:{note:bv.note,view:bv}})},_onSearchRelation:function(bu){var bt=this;T.showWait();_.delay(function(){var bw=new aE(bu.get("nodes"));var bv=[];_.each(bu.get("traces"),function(bx){_.each(bx.nodes,function(bB){var bA=bw.at(bB);var by=!_.has(bt.nodeInfoMap,bA.uid);var bz=by?bt.addNode(bA,bA.uid!=bu.nodeModel1.uid&&bA.uid!=bu.nodeModel2.uid):bt.nodeInfoMap[bA.uid].view;if(by){bv.push(bz)}})});bt._positionNodeViews(bv);_.each(bu.get("traces"),function(bx){_.each(bx.relations,function(by){var bz=bu.get("relations")[by];bt._addRelation(bz)})});bt._reportChange(a8.searchRelation);T.hide()},ReportSettings.effects.functionWaitTimeout)},_onNewReport:function(){if(this._isEmptyReport()){bt()}else{T.confirm(_i18n.Messages.report["unsaved"]+"<br>"+_i18n.Messages.report["save-prompt"]+"<br><br>"+_i18n.Messages.report["new.confirm"],"warning",{yes:bt})}function bt(){ah.unbind("beforeunload");ReportUtils.openUrl(ReportUtils.getPageBaseUrl())}},_newReport:function(bt,bu){var bu=bu?bu:new u({name:_i18n.Messages.report["new.name"]});this._initReport(bu,bt)},_openReport:function(bv){var bt=this;if(bt._isEmptyReport()){bu()}else{T.confirm(_i18n.Messages.report["unsaved"]+"<br>"+_i18n.Messages.report["save-prompt"]+"<br><br>"+_i18n.Messages.report["open.confirm"],"warning",{yes:bu})}function bu(){bt._initReport(bv,{callback:function(){bt._reportChange(a8.openReport)}})}},_saveReport:function(){var bt=this;if(bt.reportModel.id){bt.saveReport()}else{bi.open(bt.reportModel)}},_saveAsReport:function(){var bt=this;bi.open(bt.reportModel)},_onDeleteReport:function(){this._newReport()},_isEmptyReport:function(){var bu=this;var bt=bu.reportModel.toJSON();delete bt.name;return !_.any(bt)&&_.isEmpty(bu.nodeInfoMap)},_initReport:function(bv,bt){var bu=this;bt=bt||{};p();T.showWait();_.delay(function(){bu._resetHistory();bu._resetGraph();bu._resetSelect();bu._initUI();bu.reportModel=bv;bu._initGraphData();bu._setReportName(bu.reportModel.get("name"));bu._setReportNote(bu.reportModel.get("comment"));bu.toolbarView.enabledTools(["delete-report"],bv.id);bu.toolbarView.enabledTools(["export-report"],bv.id&&aZ());bu._initReportShare();T.hide();if(_.isFunction(bt.callback)){bt.callback.call(bu)}bu.trigger("initReport")},ReportSettings.effects.functionWaitTimeout)},_resetGraph:function(){var bt=this;jsPlumb.reset();$('[class*="_jsPlumb"]').remove();_.each(bt.nodeInfoMap,function(bu){bu.view.remove();delete bu.view.model});_.each(bt.nodeLinkMap,function(bu){bu.view.remove();delete bu.view.model});bt.nodeInfoMap={};bt.nodeLinkMap={};bt.selectedNodeViews=[];bt.selectedRelationViews=[]},_initGraphData:function(){var bt=this;bt.setAreaPosition({left:0,top:0});_.each(bt.reportModel.get("nodes"),function(bw){var bz=new aq(bw);var bx=bt.addNode(bz,false);var by={left:bz.get("_x"),top:bz.get("_y")};if(_.isNumber(by.left)&&_.isNumber(by.top)){by=bt._graphPosToAreaPos(by)}else{by=bt._getNextNodeViewInfo(bx).pos}bx.setPosition(by,true);var bv=bz.get("_style");bx.setTheme(bv?bv["theme"]:null);var bu=bz.get("_comment");bt.nodeInfoMap[bz.uid].note=bu;bx.showNote(bu)});_.each(bt.reportModel.get("relations"),function(bv){var by=an.getByName(bv["_type"]).toJSON();var bG=e(bv["_srcId"],by.sourceNodeType);var bw=e(bv["_dstId"],by.destinationNodeType);var bx=bt.nodeInfoMap[bG];var bD=bt.nodeInfoMap[bw];if(!bx||!bD){return}if(bv._deleted){var bF=bx.view.model;var bA=bD.view.model;var bB=bt.buildDeletedRelationText(bF,bA,bv);bt.buildLinkNodes(bF,bA,bB)}else{var bz=bt.addRelatedNode(bx.view.model,bx.view.model,bD.view.model,by,MetaUtils.getRelationTypeExtByBaseRelationType(by.name),bv,true);var bE=bx.relations[bw][by.name+"-children"];var bu=bv["_style"];if(bu){bz.setState(bu.labelState);bt._setConnectionStyle(bE.connection,bu)}var bC=bv["_comment"];if(bC&&bz.note!=bC){bC=(bz.note?(bz.note+"\r\n\r\n"):"")+bC}bz.showNote(bC)}});_.each(bt.reportModel.get("nodes"),function(bu){var bv=new aq(bu);bt._doAddRelationsExistingObject(bv)});_.each(bt.reportModel.get("links"),function(bv){var bu=new s(bv);var bx=[];_.each(bv.nodes,function(bz){var by=e(bz.id,bz.type);var bA=bt.nodeInfoMap[by].view.model;bx.push(bA)});var bw=null;if(_.isNumber(bu.get("x"))&&_.isNumber(bu.get("y"))){bw=bt._graphPosToAreaPos({left:bu.get("x"),top:bu.get("y")})}bt.linkNodes(bu,bx,bw,true,true)});jsPlumb.repaintEverything()},_buildReportModelGraphData:function(bw){var bx=this;var bv=[];var bu=[];_.each(bx.nodeInfoMap,function(by){var bA=by.view.model;var bz=bx._areaPosToGraphPos(by.view.$el.offset());bv.push(_.extend(bw?bA.toJSON():{},{"_id":bA.id,"_type":bA.get("_type"),"_comment":by.note,"_x":bz.left,"_y":bz.top,"_style":{"theme":by.view.theme}}));_.each(by.relations,function(bC,bB){_.each(bC,function(bI){if(bI.parents===false){var bF=bI.view;var bE=B(bI.connection);var bG=bE.attr("object-theme");var bD=bE.attr("line-style");var bH=bx.nodeInfoMap[bB].view.model;bu.push(_.extend({},bw?bI.relation:{},{"_srcId":bA.id,"_dstId":bH.id,"_type":bI.relationTypeExt.baseRelationTypeName,"_comment":bF.note,"_style":{"theme":bG,"lineStyle":bD,"labelState":bF.getState()}}))}})})});var bt=[];_.each(bx.nodeLinkMap,function(by){var bz=by.view.model;var bA=bx._areaPosToGraphPos(by.view.$el.offset());linkNodes=[];_.each(by.nodeModelList,function(bB){linkNodes.push({"id":bB.id,"type":bB.get("_type")})});bt.push({"comment":bz.get("comment"),"x":bA.left,"y":bA.top,"nodes":linkNodes})});return{nodes:bv,relations:bu,links:bt}},_areaPosToGraphPos:function(bt){return{left:bt.left-ReportSettings.areaBounds.left,top:bt.top-ReportSettings.areaBounds.top}},_graphPosToAreaPos:function(bt){return{left:bt.left+ReportSettings.areaBounds.left,top:bt.top+ReportSettings.areaBounds.top}},_initUI:function(){var bt=this;a5.close();bi.close();a1.close();bs.close();aL.close();M.close();aS.close();aw.close();al.close();bt._closeReportNoteWidget();a6.close();l.close();C.close();bt.toolbarView.enabledTools(bt.toolbarView.objectSelectedTools,false)},_getUrlShareKey:function(bu){var bt=$.url(document.location.href).param();return bt[ReportUtils.reportShareKeyParam]},_openUrlNodes:function(bx){var by=this;var bu=$.url(document.location.href).param();var bw="node.type";if(_.has(bu,bw)){var bt=bu[bw];delete bu[bw];var bv=new aE();bv.fetch({url:bv.baseUrl+"/nodes/"+bt,data:bu,error:function(bA,bz){bx.complete(false,bz)},success:function(bC,bA){var bB=by._doAddNode(bv.toArray(),true);if(bB.length==1){var bz=bB[0];by._positionNodeViewOfWindowCenter(bz);jsPlumb.repaint(bz.$el)}bx.complete(true,bA)}})}else{bx.complete(true)}},_setReportName:function(bt){this.$reportName.text(bt);document.title=ReportUtils.buildPageTitle([bt])},_setReportNote:function(bt){var bu=this;bt=$.trim(bt);bu.reportModel.set({comment:bt});bu.$reportNoteText.val(bt)},_onReady:function(){var bu=this;bu.toolbarView.on("onNewReport",bu._onNewReport,bu);bu.toolbarView.on("onSaveReport",bu._saveReport,bu);bu.toolbarView.on("onSaveAsReport",bu._saveAsReport,bu);a5=new n();a5.on("onOpenReport",bu._openReport,bu);bi=new a({reportView:bu});a1=new bg({reportView:bu});a1.on("onDeleteReport",bu._onDeleteReport,bu);bs=new j({reportView:bu});aL=new af({reportView:bu});aL.on("onAddNode",bu._doAddNode,bu);M=new aN({reportView:bu});M.on("onAddRelatedNode",bu._doAddRelatedNode,bu);aS=new v({reportView:bu});aw=new bh({reportView:bu});aw.on("delete",bu._doDeleteNode,bu);a6=new ad({reportView:bu});l=new aa({reportView:bu});C=new aJ({reportView:bu});C.on("doDelete",bu._doLinkNodesDelete,bu);aV=new r({reportView:bu});aV.on("onSearchRelation",bu._onSearchRelation,bu);al=new aA({reportView:bu});bu.userModel=new ao();bu.userModel.fetch({error:function(bw,bv){bt(true,bv)},success:function(){bt()}});N.bind("keydown","shift+1",function(){Logger.log("report",bu.reportModel.id,bu.reportModel.attributes);var bv={"COMPANY":"nameshortsort","INDIVIDUAL":"name","ADDRESS":"value","PHONE":"value"};_.each(bu.selectedNodeViews,function(bx){var by=bx.model;var bw=by.get("_type");Logger.log(bw+"."+by.id,"("+by.get(bv[bw])+")",by.attributes)})});function bt(bA,bw){var bz=bu._getUrlShareKey();var bv;var by=bu.userModel.get("userId");if(bz){bv=new u();bv.fetchShared(bz,{error:function(bD,bB){var bE=_.template(K.filter("#share-report-notfound-view-template").html());var bC=bE();T.showMessage(bC,"error",true)},success:function(){if(bv.get("userId")!=by){bv.set({"id":null})}bx(bv)}})}else{bx()}function bx(bB){if(bA&&!bB){if(bw.responseText==ReportUtils.accessDeniedErrorKey){var bC=K.filter("#access-denied-view-template").html();T.showMessage(bC,"error",true)}else{T.showMessage(_i18n.Messages["error.system"],"error",true)}}else{ah.bind("beforeunload",function(){if(window._DEVELOPMENT_){}else{return _i18n.Messages.report["unsaved"]+"\r\n"+_i18n.Messages.report["save-prompt"]}});bu._newReport({callback:function(){bu._openUrlNodes({complete:function(bE,bD){if(by){bu.trigger("authenticate")}bu._reportChange(a8.openUrlNodes);if(bE){T.hide()}else{T.showMessage(ReportUtils.getServerErrorMessage(bD.responseText),"error")}bu.trigger("onReady");if(bu._isUserAnonymous()){bu.toolbarView.addToolsClass(["demo-info"],"active")}if(bB&&!by){bu.toolbarView.strongDisabledTools(["new-report","open-report","save-report","save-as-report","delete-report","export-report","add-node","add-related-nodes","show-delete","search-relation","link-nodes","report-note","report-share"])}}})}},bB)}}}},demoHTML:K.filter("#access-demo-view-template").html(),checkPermissions:function(bt){var bu=this;if(bu.userModel.hasPermissions(bt)){return true}T.showMessage(bu.demoHTML,"warning",false);return false},_buildConnection:function(bI,bH,bu,bD,bF,bz,bJ){var bL=this;var bG=MetaUtils.getRelationType(bD.name);var bK=bH.model.uid;var bC=bu.model.uid;var bw=bL.nodeInfoMap[bK];var bt=bL.nodeInfoMap[bK];var bv=(bK==bI.uid);if(!bz){var bx=(bI.uid==bK?bu.model.get("_relations"):bH.model.get("_relations"));bz=_.find(bx,function(bN){return(bN._type==bD.name&&(bv?e(bN._srcId,bD.sourceNodeType)==bK:e(bN._dstId,bD.destinationNodeType)==bC))})}var by;var bE;if(bJ){by=bJ.view;by.addRelation(bz);bE=bJ.connection}else{by=new D({srcNodeView:bH,dstNodeView:bu});by.addRelation(bz);by.on("onNote",bL._onRelationNote,this);bE=jsPlumb.connect({source:bH.id,target:bu.id,overlays:aT()},_.extend(U,bF.jsPlumb));var bM=B(bE);var bA=$(bE.connector.canvas);var bB=_.uniqueId();bM.attr("connection-label-id",bB);bA.attr("paint-style-with-dashstyle",true).attr("connection-label-id",bB);_.each(bE.overlays,function(bN){$(bN.canvas).attr("connection-label-id",bB)});_.each(bE.endpoints,function(bN){$(bN.canvas).children().each(function(){$(this).attr("connection-label-id",bB)})});bM.append(by.$el).bind("mouseenter",{connection:bE},function(bN){bL._connectionHover(bN.data.connection,true,bN)}).bind("mouseleave",{connection:bE},function(bN){bL._connectionHover(bN.data.connection,false,bN)});bE.bind("mouseenter",function(bN,bO){bL._connectionHover(bN,true,bO)});bE.bind("mouseexit",function(bN,bO){bL._connectionHover(bN,false,bO)});bE.bind("click",function(bN,bO){bL._relationClick(by,bO)});by.connection=bE;by.on("onSelectChange",function(bN){bL._setConnectionPaintStyle(bN.connection)});bL.relationLabelDragHelperView.initDrag(by)}by.render();bw.view.repaint(bw);bt.view.repaint(bt);return{connection:bE,view:by,relation:bz}},_nodeViewHover:function(bx,bu,bw){var bv=this;var bt=jsPlumb.getConnections({source:bx.id});_.each(bt,function(by){bv._connectionHover(by,bu,bw)})},_connectionHover:function(bw,bu,bx){var bv=this;var bt=B(bw);if(!bu&&(bt.find(bx.relatedTarget).length>0)){return}if(bu){bt.addClass("hover")}else{bt.removeClass("hover")}bv._setConnectionPaintStyle(bw)},_setConnectionPaintStyle:function(bt){var bA=this;var bC=B(bt);var bB=[bt.source,bt.target];var bx=bC.hasClass("selected");var bz=bC.hasClass("hover");var bw=bC.hasClass("node-selected");var by=aG(bC.attr("object-theme"));var bD=a4(bC.attr("line-style"));var bu=_.extend({},U.paintStyle,by.connection.paintStyle,bD,(bz?a0.hoverPaintStyle:{}),(bx?a0.selectPaintStyle:{}),(bw?a0.nodeSelectPaintStyle:{}));var bv=_.extend({},U.endpointStyle,by.connection.paintStyle?{fillStyle:by.connection.paintStyle.strokeStyle}:{},(bz?a0.endpointHoverStyle:{}),(bx?a0.endpointSelectStyle:{}),bw?{fillStyle:a0.nodeSelectPaintStyle.strokeStyle}:{});bt.setPaintStyle(bu);_.each(bt.endpoints,function(bE){bE.setPaintStyle(bv)});_.each(bB,function(bE){if(bz){bE.addClass("hover")}else{bE.removeClass("hover")}})},saveReport:function(bt,bu){var bv=this;if(!bv.checkPermissions(["REPORT_SAVE"])){return}var bu=bu||{};var bw=bv._buildReportModelGraphData();T.showWait();bv.reportModel.save(_.extend({shared:bv._isShared()},bt,bw),{error:function(bx,by){T.showMessage(ReportUtils.getServerErrorMessage(by.responseText),"error");if(_.isFunction(bu.error)){bu.error.call(bv,bx,by)}},success:function(){bv._setReportName(bv.reportModel.get("name"));bv.toolbarView.enabledTools(["delete-report"],true);bv.toolbarView.enabledTools(["export-report"],aZ());bv._initReportShare();T.hide();if(_.isFunction(bu.success)){bu.success.call(bv)}}})},isNodeExists:function(bt){return _.has(this.nodeInfoMap,bt.uid)},addNode:function(bx,bu){var bv=this;var bt=bx.uid;if(_.has(bv.nodeInfoMap,bt)){var bw=bv.nodeInfoMap[bt].view;bw.model=bx;if(bu){aQ(bw.$el,true)}return bw}var bw=new aM({model:bx,reportView:bv});bw.render(bv.reportAreaView.getAreaEl());this._initNodeDrag(bw);bw.on("onNote",bv._onNodeNote,this);bw.on("onClick",bv._onNodeClick,this);bw.$el.mouseenter(function(by){bv._nodeViewHover(bw,true,by)}).mouseleave(function(by){bv._nodeViewHover(bw,false,by)});this.nodeInfoMap[bt]={view:bw,relations:{}};if(bu){aQ(bw.$el,true)}return bw},addRelatedNode:function(bL,bz,bT,bC,bA,by,bu){var bS=this;var bw={"true":"-parents","false":"-children"};var bD=bz.uid;var bx=bT.uid;var bO=bz.uid==bL.uid?bx:bD;var bR=bS.nodeInfoMap[bO]?false:true;var bP=bS.addNode(bz,bu?false:bz.uid!=bL.uid);var bN=bS.addNode(bT,bu?false:bz.uid==bL.uid);var bK=bS.nodeInfoMap[bD].relations[bx];var bv=bC.name+bw[false];if(bK&&_.has(bK,bv)){return bK[bv].view}var bM=_.find(bK,function(bV,bU){return _.endsWith(bU,bw[false])});var bI={};bI[bC.name+bw[false]]={relationTypeExt:bA,parents:false};bS.nodeInfoMap[bD].relations[bx]=_.extend(bI,bK);var bH=bS.nodeInfoMap[bx].relations[bD];var bF={};bF[bC.name+bw[true]]={relationTypeExt:bA,parents:true};bS.nodeInfoMap[bx].relations[bD]=_.extend(bF,bH);var bB=bz.uid==bL.uid?bT:bz;var bQ=bz.uid==bL.uid?bN:bP;var bt={nodeModel:bL,toNodeModel:bB,relationType:bC,relationTypeExt:bA};var bJ=bS._getNextNodeViewInfo(null,bt);if(bR){bQ.setPosition(bJ.pos)}var bG=bS._buildConnection(bL,bP,bN,bC,bJ.connection,by,bM);var bE=bG.connection;bI[bC.name+bw[false]]={relation:bG.relation,connection:bE,view:bG.view,relationTypeExt:bA,parents:false};bS.nodeInfoMap[bD].relations[bx]=_.extend(bI,bK);return bG.view},getAreaPosition:function(){return this.reportAreaView.getAreaEl().offset()},setAreaPosition:function(bt){this.reportAreaView.getAreaEl().css({"left":bt.left+"px","top":bt.top+"px"})},linkNodes:function(bu,bx,by,bz,bB){var bA=this;var bw=bu.uid;if(_.has(bA.nodeLinkMap,bw)){var bC=bA.nodeLinkMap[bw].view;bC.render();jsPlumb.repaint(bC.$el);if(!bz){bA._reportChange(a8.linkNodes)}return bC}else{var bC=new az({model:bu,reportView:bA});bC.render();bC.on("onClick",bA._onNodeClick,bA);bC.on("onEdit",bA._onLinkNodesEdit,bA);bC.on("onDelete",bA._onLinkNodesDelete,bA);bC.$el.mouseenter(function(bD){bA._nodeViewHover(bC,true,bD)}).mouseleave(function(bD){bA._nodeViewHover(bC,false,bD)});bA.reportAreaView.getAreaEl().append(bC.$el);var bt={left:Number.MAX_VALUE,top:Number.MAX_VALUE,right:-Number.MAX_VALUE,bottom:-Number.MAX_VALUE};_.each(bx,function(bG){var bE=bA.nodeInfoMap[bG.uid].view;var bD=jsPlumb.connect({source:bC.id,target:bE.id,overlays:aT()},U);var bF=bE.$el.offset();if(bt.left>bF.left){bt.left=bF.left}if(bt.top>bF.top){bt.top=bF.top}if(bt.right<bF.left){bt.right=bF.left}if(bt.bottom<bF.top){bt.bottom=bF.top}});bA._initNodeDrag(bC);bA.nodeLinkMap[bw]={view:bC,nodeModelList:bx};var bv=bA.getAreaPosition();bC.setPosition(by?by:{left:bt.left+Math.floor((bt.right-bt.left)/2)-bv.left,top:bt.top+Math.floor((bt.bottom-bt.top)/2)-bv.top},bB);jsPlumb.repaint(bC.$el);if(!bz){bA._reportChange(a8.linkNodes)}return bC}},buildDeletedRelationText:function(bv,bu,bt){return""+_i18n.Messages.report["data.outdated"]+"\r\n\r\n"+MetaUtils.getNodeTitleValue(bv.toJSON())+"\r\n"+MetaUtils.getRelationType(bt._type).relationTitle+"\r\n"+MetaUtils.getNodeTitleValue(bu.toJSON())+(bt._comment?("\r\n\r\n"+bt._comment):"")+""},buildLinkNodes:function(bw,bv,bx){var bu=this;var bt=new s({nodes:[{id:bw.id,type:bw.get("_type")},{id:bv.id,type:bv.get("_type")}],comment:bx,x:null,y:null});bu.linkNodes(bt,[bw,bv],null,true)},_onLinkNodesEdit:function(bu){var bv=this;var bt=bu.uid;var bw=bv.nodeLinkMap[bt].nodeModelList;l.openEdit(bu,bw)},_onLinkNodesDelete:function(bu){var bv=this;var bt=bu.uid;var bw=bv.nodeLinkMap[bt].nodeModelList;C.openDelete(bu,bw)},_doLinkNodesDelete:function(bv,bt){var bw=this;var bu=bv.uid;var bx=bw.nodeLinkMap[bu].view;jsPlumb.detachAllConnections(bx.$el);delete bw.nodeLinkMap[bu];bx.remove();a6.close();l.close();C.close();if(!bt){bw._reportChange(a8.deleteLinkNodes)}},selectObjectTheme:function(bu){var bt=this;_.each(bt.selectedNodeViews,function(bv){bv.setTheme(bu)});_.each(bt.selectedRelationViews,function(bv){bt._setConnectionTheme(bv.connection,bu)});bt._reportChange(a8.objectTheme)},selectLineStyle:function(bt){var bu=this;_.each(bu.selectedRelationViews,function(bv){bu._setConnectionLineStyle(bv.connection,bt)});bu._reportChange(a8.lineStyle)},_setConnectionTheme:function(bw,bx){var bv=this;var bt=B(bw);var bu=aG(bx);bt.attr("object-theme",bx).removeClass(ObjectTheme.objectViewClasses).addClass(bu.objectViewClass);bv._setConnectionPaintStyle(bw)},_setConnectionLineStyle:function(bw,bu){var bv=this;var bt=B(bw);bt.attr("line-style",bu);bv._setConnectionPaintStyle(bw)},_setConnectionStyle:function(bx,bv){var bw=this;var bt=B(bx);var bu=aG(bv.theme);bt.attr("object-theme",bv.theme).attr("line-style",bv.lineStyle).removeClass(ObjectTheme.objectViewClasses).addClass(bu.objectViewClass);bw._setConnectionPaintStyle(bx)},_onNodeClick:function(bu,bt){this._doSelect(bu,bt)},_relationClick:function(bu,bt){this._doSelect(bu,bt)},isMultiplySelect:function(bt){return bt&&bt.shiftKey},isViewSelected:function(bt){return _.contains(this.selectedViews,bt)},_resetSelect:function(){var bt=this;bt.selectedViews=[];bt.selectedNodeViews=[];bt.selectedRelationViews=[];bt.selectedViewsOld=[]},_doSelect:function(bC,bu,bw){var bB=this;var bD=false;var bx=true;if(bw){bD=bw.select;bx=bw.unselect}else{var bv=bB.isViewSelected(bC);var bt=(bu.type==="dragstart");var bz=bB.isMultiplySelect(bu);bD=bv?(bt?true:!bz):true;bx=!(bz||(bt&&bv))}var bE=bB.selectedViews.slice(0);var bA=[];if(bD){bA=bx?_.without(bB.selectedViews,bC):[];bB.selectedViews=bx?[bC]:_.union(bB.selectedViews,[bC])}else{bB.selectedViews=_.without(bB.selectedViews,bC)}bC._select(bD);_.each(bA,function(bF){bF._select(false)});bB.selectedNodeViews=[];bB.selectedRelationViews=[];_.each(bB.selectedViews,function(bF){if(bF.viewClassName==bq.NodeGraphView||bF.viewClassName==bq.LinkNodeGraphView){bB.selectedNodeViews.push(bF)}if(bF.viewClassName==bq.RelationLabelView){bB.selectedRelationViews.push(bF)}});var by=bE.length!=bB.selectedViews.length?true:_.difference(bE,bB.selectedViews).length>0;if(by){bB.trigger("onViewsSelectChange",bB.selectedNodeViews,bB.selectedRelationViews);bB.trigger("onNodeViewsSelectChange",bB.selectedNodeViews)}},_onSelectAreaStart:function(bt){this.selectedViewsOld=this.selectedViews.slice(0)},_onSelectArea:function(bu,bx){var bw=this;var by=bw.isMultiplySelect(bx);_.each(bw.nodeInfoMap,function(bz){bt(bz.view)});_.each(bw.nodeLinkMap,function(bz){bt(bz.view)});function bt(bB){var bC=_.contains(bw.selectedViewsOld,bB);var bA=bv(bB);var bz=bA?(by?!bC:true):(by&&bC);bw._doSelect(bB,null,{select:bz,unselect:false})}function bv(bA){var bB=bA.$el;var bD=bB.offset();var bC=bB.outerWidth();var bz=bB.outerHeight();if(bu.left<=bD.left+bC&&bD.left<=bu.left+bu.width&&bu.top<=bD.top+bz&&bD.top<=bu.top+bu.height){return true}return false}},_reportChange:function(bu,bw,bv){var bt=this;if(!bv){bt._doSaveHistory();bt._pushReportState(bu)}bt.trigger("reportChange",bu,bw)},_resetHistory:function(){var bt=this;bt.historyList=[];bt.historyIndex=0;bt.trigger("onHistoryChange",bt._getHistoryInfo())},_doSaveHistory:function(){var bt=this;_.defer(function(){var bu=_.extend(bt.reportModel.toJSON(),bt._buildReportModelGraphData(true));if(bt.historyList.length==bt.historySize){bt.historyList=_.rest(bt.historyList)}bt.historyList.push({report:bu});bt.historyIndex=bt.historyList.length-1;bt.trigger("onHistoryChange",bt._getHistoryInfo())})},_doHistory:function(bu){var bt=this;var bv=bt.historyList[bu];T.showWait();_.delay(function(){bt._resetGraph();bt._resetSelect();bt._initUI();bt.reportModel.set(_.extend({},bv.report,{name:bt.reportModel.get("name")}));bt._initGraphData();bt._setReportNote(bt.reportModel.get("comment"));bt.trigger("onHistoryChange",bt._getHistoryInfo());bt.trigger("onHistory",bt._getHistoryInfo());bt._pushReportState(a8.doHistory);T.hide()},ReportSettings.effects.deferTimeout)},_checkHistoryIndex:function(){var bt=this;bt.historyIndex=bt.historyIndex<0?0:(bt.historyIndex>(bt.historyList.length-1)?(bt.historyList.length-1):bt.historyIndex)},_getHistoryInfo:function(){var bt=this;return{canUndo:bt.historyIndex>0,canRedo:bt.historyIndex<bt.historyList.length-1}},undo:function(){var bt=this;bt.historyIndex--;bt._checkHistoryIndex();bt._doHistory(bt.historyIndex)},redo:function(){var bt=this;bt.historyIndex++;bt._checkHistoryIndex();bt._doHistory(bt.historyIndex)},_initReportShare:function(){var bt=this;bt.toolbarView.enabledTools(["report-share"],bt.reportModel.id);var bu=bt.reportModel.get("shareKey");bt.$reportShareUrl.val(bu?ReportUtils.buildReportShareUrl(bu):"");bt.markedShared(bt.reportModel.get("shared"))},notification:function(bt){this.reportNotificationWidget.notification(bt)},_pushReportState:function(bv){var bu=this;if(!bu._canPushStateByUser()||!_.contains(w,bv)||(_.contains(aU,bv)&&_.size(bu.nodeInfoMap)==0)){return}var bt=[];_.each(bu.nodeInfoMap,function(bw){var bx=bw.view.model;bt.push({"id":bx.id,"type":bx.get("_type")})});bu.reportUpdater.pushState({nodes:bt})},_isUserAnonymous:function(){var bt=this.userModel.get("userId");return(ReportUtils.anonymousUserId==bt)},_canPushStateByUser:function(){var bu=this;var bt=bu.userModel.get("userId");return(bt&&!bu._isUserAnonymous())},getNodeInfo:function(bt){return this.nodeInfoMap[bt]},activateNodeView:function(bu){var bt=this;bt._doSelect(bu,null,{select:true,unselect:true});var bv=bu.$el.offset();window.scrollTo(bv.left-ReportSettings.areaBounds.left,bv.top-ReportSettings.areaBounds.top)},ReportUpdateDataSource:{"egrul":{NotificationView:a2},"egrul_individual_founder":{NotificationView:ar},"egrul_individual_executive":{NotificationView:P}},_onReportUpdate:function(by){if(_.isEmpty(by)){Logger.log("_onReportUpdate: nothing to update: data is blank");return}var bw=this;var bz=ReportUtils.DataSource[by.source];if(!bz){throw new Error("Unsupported data source: "+by.source)}bw.checkUpdateRelations(by);var bu=e(by.holder._id,by.holder._type);var bt=bw.getNodeInfo(bu);if(bt){var bv=bw.nodeInfoMap[bu].view;var bx=bv.model;bw._reportChange(a8.update,{dataSource:bz,holderNodeModel:bx},true);bw.notification(new bw.ReportUpdateDataSource[bz.id].NotificationView({holderNodeModel:bx,type:by.type}))}else{if(by.type=="DATA_UPDATE"){bw.notification(new bm({content:_i18n.Messages["report.update"]}))}}},checkUpdateRelations:function(bw){var bv=this;var bx=[];var bu=[];var bt=[];var by=[];_.each(bw.nodes,function(bD){var bB=e(bD._id,bD._type);var bA=bv.getNodeInfo(bB);if(bA){bA.view.model.set(bD,{silent:true});bx.push(bA);var bC=F(bA);_.each(bC,function(bF){var bE=_.find(bD._relations,function(bG){return ba(bG,bF.relation)});if(!bE){bu.push(bF)}});_.each(bD._relations,function(bF){if(bD._id===bF._srcId){var bG=_.find(bC,function(bH){return ba(bH.relation,bF)});if(bG){var bE=bl(bF,bG.relation,_excludeRelationDiffAttributes);if(bE.length>0){bt.push({relation:bF,relationInfo:bG,differentAttributes:bE})}}else{by.push(bF)}}});var bz=bA.view.model;bz.set("_relations",bD._relations)}});bv._deleteRelations(bu,true);_.each(bt,function(bA){var bz=bA.relationInfo.view;S(bA.relation,bA.relationInfo.relation,bA.differentAttributes);if(bz.isContent){bz.render()}});_.each(by,function(bz){bv._addRelation(bz)});_.each(bx,function(bz){bz.view.repaint(bz)})},_addRelation:function(bz){var by=this;var bw=an.getByName(bz["_type"]).toJSON();var bu=e(bz["_srcId"],bw.sourceNodeType);var bv=e(bz["_dstId"],bw.destinationNodeType);var bx=by.nodeInfoMap[bu];var bt=by.nodeInfoMap[bv];if(bx&&bt){by.addRelatedNode(bx.view.model,bx.view.model,bt.view.model,bw,MetaUtils.getRelationTypeExtByBaseRelationType(bw.name),bz)}},_deleteRelations:function(bv,bt){var bu=this;_.each(bv,function(bD){var bB=bD.view;var bw=bD.relation;bu._doSelect(bB,null,{select:false,unselect:true});var bF=bB.srcNodeView.model.uid;var bx=bB.dstNodeView.model.uid;var by=bu.nodeInfoMap[bF];var bC=bu.nodeInfoMap[bx];delete by.relations[bx][bw._type+"-children"];delete bC.relations[bF][bw._type+"-parents"];bB.removeRelation(bw);if(bB.getRelationCount()>0){bB.render()}else{bB.remove();jsPlumb.detach(bD.connection)}if(bt){var bE=by.view.model;var bz=bC.view.model;var bA=bu.buildDeletedRelationText(bE,bz,bw);bu.buildLinkNodes(bE,bz,bA)}by.view.repaint(by);bC.view.repaint(bC)})}});function H(bv,bu,bt){_.each(bv.get("_relations"),function(bw){if(bu=="parents"||bu=="children"){if(bu=="parents"&&bw._dstId==bv.id){bt(bw)}else{if(bu=="children"&&bw._srcId==bv.id){bt(bw)}}}else{bt(bw)}})}function A(bt,bv,bu){_.each(bt.relations,function(bw){_.each(bw,function(bx){if(bv=="parents"||bv=="children"){if(bv=="parents"&&bx.parents){bu(bx.relation)}else{if(bv=="children"&&!bx.parents){bu(bx.relation)}}}else{bu(bx.relation)}})})}function aX(bt){var bu=[];_.each(bt.relations,function(bv){_.each(bv,function(bw){if(!bw.parents){bu.push(bw.relation)}})});return bu}function F(bt){var bu=[];_.each(bt.relations,function(bv){_.each(bv,function(bw){if(!bw.parents){bu.push(bw)}})});return bu}_excludeRelationDiffAttributes=["_type","_srcId","_dstId","_holderDst","_style"];function bl(bw,bv,bu){var bt=[];_.each(bw,function(by,bx){if(!_.contains(bu,bx)&&by!==bv[bx]){bt.push(bx)}});return bt}function S(bu,bv,bt){_.each(bt,function(bw){bv[bw]=bu[bw]})}function ba(bu,bt){return(bu._type===bt._type)&&(bu._srcId===bt._srcId)&&(bu._dstId===bt._dstId)}function L(bv){var bt="";var bu=bv.getLiqStatus();if(bu){bt+="liq"}return bt}function aQ(bt,bu){if(bu){bt.addClass("added")}else{bt.removeClass("added")}}function aT(){return[["Arrow",{width:10,length:10,location:1,id:"dst-overlay"}],["Label",{label:null,cssClass:aI,location:0.5,id:"label"}]]}function aG(bt){if(_.has(ObjectTheme.themes,bt)){return ObjectTheme.themes[bt]}else{return ObjectTheme.themes[ObjectTheme.defaultThemeName]}}function B(bu){var bt=bu.getOverlay("label");return(bt?$(bt.canvas):$())}function aZ(){var bt=jsPlumb.getRenderMode();return(bt==jsPlumb.SVG||bt==jsPlumb.VML)}function av(bt){return confirm(bt)}function at(bv,bw,bu){var bt={"unselectable":"on","onselectstart":"return false;"};if(!bw){bv.attr(bt)}bv.find(bu?bu:"*").attr(bt)}function x(){return{clientWidth:Math.max(ae.prop("scrollWidth"),N.innerWidth()),clientHeight:Math.max(ae.prop("scrollHeight"),N.innerHeight())}}function ai(bt){bt.find("input, textarea").each(function(){var bu=$(this);bu.val($.trim(bu.val()))})}function aW(bt){$.ajax({type:bt.method||"GET",url:bt.url,data:JSON.stringify(bt.data),dataType:"json",contentType:"application/json",error:function(bu){if($.isFunction(bt.error)){bt.error.call(this,bu)}else{T.showMessage(ReportUtils.getServerErrorMessage(bu.responseText),"error")}},success:function(bu){if($.isFunction(bt.success)){bt.success.call(this,bu)}}})}function aO(bK,bE,bt){T.showWait();var bu="";var by=ReportUtils.getApplUrl();$("head").find("link.for-export").each(function(){var bL=$(this);bu+='<link href="'+(by+bL.attr("href"))+'" rel="'+bL.attr("rel")+'" />'});var bw="";if(jsPlumb.getRenderMode()==jsPlumb.SVG){var bI=$(".report-area-view").clone();bC(bI);bI.find("svg").each(function(){var bL=$(this);var bM=bL.clone();var bN=bx(bM);bP(bM.find("*, path, circle"));bP(bM);bN.append(bM);var bO=bG(bN.html());bN.empty().append(bO);bL.replaceWith(bN);function bP(bQ){bQ.removeAttr("style class xmlns version position pointer-events")}});bw=bI.html();bI.remove()}else{if(jsPlumb.getRenderMode()==jsPlumb.VML){var bA=$(".report-area-view");bA.find(".jsplumb_vml").each(function(bL,bM){$(bM).attr("vmlid",bL)});var bI=bA.clone();bC(bI);var bJ={elements:{"shape":{jsplumbTag:"jsplumb:shape",svgTag:"path",convert:function(bM,bP){var bQ=bv(bM.attr("path"));var bN=bM.width();var bL=bM.height();var bO=bM.attr("paint-style-with-dashstyle")?bP["svg-stroke-dasharray"]:"";return'<svg width="'+bN+'" height="'+bL+'"><path d="'+bQ+'" fill="none" stroke="'+bP.strokeStyle+'" stroke-width="'+bP.lineWidth+'" stroke-dasharray="'+bO+'"></path></svg>'}},"oval":{jsplumbTag:"jsplumb:oval",svgTag:"circle",convert:function(bM,bO){var bN=bM.width();var bL=bM.height();return'<svg width="'+bN+'" height="'+bL+'"><circle cx="'+bN/2+'" cy="'+bL/2+'" r="'+bN/2+'" fill="'+bO.strokeStyle+'" stroke="none"></circle></svg>'}}}};var bH={};bI.find(".jsplumb_vml").each(function(bS,bM){var bT=$(bM);var bX=$(bA.find('.jsplumb_vml[vmlid="'+bT.attr("vmlid")+'"]')[0].outerHTML);var bO=bX[0].tagName;if(!_.has(bJ.elements,bO)){return}var bZ=bJ.elements[bO];var bN="svg-object key-"+bS;var bV=$("<object/>",{type:bN});var bQ=bT.attr("connection-label-id");var bU=bA.find("."+aI+'[connection-label-id="'+bQ+'"]');var bR=aG(bU.attr("object-theme"));var bY=a4(bU.attr("line-style"));var bP=_.extend({},U.paintStyle,bR.connection.paintStyle,bY);var bL=bZ.convert(bX,bP);var bW=bG(bL);bH[bN]='<object type="image/svg+xml" style="'+bX.attr("style")+'" class="'+bX.attr("class")+'">'+bW.xml+"</object>";bT.replaceWith(bV);bX.remove()});bw=bI.html();bI.remove();_.each(bH,function(bM,bL){bw=bw.replace(new RegExp('<\\s*object\\s+type="'+bL+'"\\s*>\\s*<\\s*/\\s*object\\s*>',"mi"),bM)})}}function bC(bL){var bM={".node-graph-view":"hover added selected",".relation-label":"hover selected node-selected"};_.each(bM,function(bO,bN){bL.find(bN).removeClass(bO)})}function bx(bL){return $("<object/>",{type:"image/svg+xml",style:bL.attr("style"),"class":bL.attr("class")})}function bv(bL){var bO=bL.toUpperCase().replace(/^\s+|\s+e\s*$|\s+xe\s*$/gim,"").replace(/([0-9]+\.?[0-9]+)/gim,function(bP){return(bP/1000)});if(bO.indexOf("L")>0){var bN=/M([^L]+)L/;var bM=bN.exec(bO);if(bM&&bM.length>1){bO+=(","+bM[1])}}return bO}function bG(bL){var bM=$.parseXML("<root></root>");return $(bM)[0].createCDATASection(bL)}var bB=br.reportAreaView.getAreaEl();var bz='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">'+'<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru">'+'<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" />'+bu+"</head>"+'<body class="'+ae.attr("class")+'"><div class="report-area-view export" style="'+bB.attr("style")+'">'+bw+"</div></body>"+"</html>";br._checkNodeViewsBounds();var bF=Math.ceil(br.nodeViewsBounds.right-br.nodeViewsBounds.left+br.nodeViewsSafetySpace.right);var bD=Math.ceil(br.nodeViewsBounds.bottom-br.nodeViewsBounds.top+br.nodeViewsSafetySpace.bottom);$.fileDownload(ReportSettings.apiUrl+"/export/"+bE+"/"+bK+"."+bE,{httpMethod:"POST",data:_.extend({reportHTML:_.escape(bz),width:bF,height:bD},bt),encodeHTMLEntities:false,failCallback:function(bL){T.showMessage(_i18n.Messages["file.download.fail"],"error")},successCallback:function(){T.hide()}})}br=new f();function a9(){var bt=new aE();bt.fetch({url:bt.baseUrl+"/nodes/COMPANY?chief.contains=малеев",success:function(){var by=bt.at(0);br._doAddNode([by,bt.at(1)]);var bx="EXECUTIVE_INDIVIDUAL";var bv=new aE();bv.fetch({url:bv.baseUrl+"/node/"+by.id+"/"+bx+"/parents",success:function(){var bz=bv.at(0);br._doAddRelatedNode(by,[{dstNodeModel:by,srcNodeModel:bz,relationType:an.getByName(bx).toJSON(),relationTypeExt:MetaUtils.getRelationTypeExtByBaseRelationType(bx)}])}});var bw="PHONE";var bu=new aE();bu.fetch({url:bu.baseUrl+"/node/"+by.id+"/"+bw+"/parents",success:function(){var bz=bu.at(0);br._doAddRelatedNode(by,[{dstNodeModel:by,srcNodeModel:bz,relationType:an.getByName(bw).toJSON(),relationTypeExt:MetaUtils.getRelationTypeExtByBaseRelationType(bw)}])}})}})}bd.delegate("a.file-download","click",function(){$.fileDownload($(this).attr("href"),{httpMethod:"GET",failCallback:function(){T.showMessage(_i18n.Messages["file.download.fail"],"error")}});return false});var W={postId:{"COMPANY":null,"INDIVIDUAL":null,"ADDRESS":null,"PHONE":null}};var ag=null;function bk(bt,bv,bu){if(!ag){return}if(bu){ag.show(bt,bv,bu)}else{ag.hide();throw"postId is invalid"}}function p(){if(!ag){return}ag.hide()}return{initCommentWidget:function(bt){W=_.extend(W,bt);ag=new CommentWidget({messageWidget:T})}}};